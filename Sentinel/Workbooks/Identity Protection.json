{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "value::selected"
        ],
        "parameters": [
          {
            "id": "980b4d73-b783-4b1c-a72f-72e14ccae04c",
            "version": "KqlParameterItem/1.0",
            "name": "DefaultSubscription_Internal",
            "type": 1,
            "isRequired": true,
            "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| take 1\r\n| project subscriptionId",
            "crossComponentResources": [
              "value::selected"
            ],
            "isHiddenWhenLocked": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "8234e576-0e92-4101-80c4-7740cd41ad50",
            "version": "KqlParameterItem/1.0",
            "name": "pn_Subscription",
            "label": "Subscription",
            "type": 6,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "summarize by subscriptionId\r\n| project value = strcat(\"/subscriptions/\", subscriptionId), label = subscriptionId, selected = iff(subscriptionId =~ '{DefaultSubscription_Internal}', true, false)",
            "crossComponentResources": [
              "value::selected"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "21fb5e7e-4760-4afa-8e85-59a2bfc2c26e",
            "version": "KqlParameterItem/1.0",
            "name": "pn_Workspace",
            "label": "Workspace",
            "type": 5,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| where strcat('/subscriptions/',subscriptionId) in ({pn_Subscription})\r\n| project id",
            "crossComponentResources": [
              "value::selected"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ]
          }
        ],
        "style": "pills",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "name": "parameters - 9"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "62cde8b6-dfd4-459d-b84f-b1de69f59310",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Sign-in Error",
            "subTarget": "SignInTab",
            "style": "link"
          },
          {
            "id": "92195655-efd8-48ad-98a8-ec7dbb0333fb",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "CA Status",
            "subTarget": "CAStatus",
            "style": "link"
          },
          {
            "id": "b943fa20-6780-4d12-ab60-2b0b1a6b8def",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "CA Access Gap",
            "subTarget": "CAGap",
            "style": "link"
          },
          {
            "id": "4dea6988-5554-47fc-aac5-ec547cfc040f",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Conditonal Access Insights",
            "subTarget": "CondAccess",
            "style": "link"
          },
          {
            "id": "b44e4b07-e768-402b-9b16-73ef027c6fb0",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Legacy Authentication",
            "subTarget": "LegacyAuth",
            "style": "link"
          },
          {
            "id": "2179deb8-3f12-47d5-a9d7-013d80cef617",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Identity Protection Risk Analysis",
            "subTarget": "IdProt",
            "style": "link"
          },
          {
            "id": "27847137-f37a-48c7-900d-3b41620eaec9",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Authentication Methods Activity",
            "subTarget": "AuthMethod",
            "style": "link"
          },
          {
            "id": "51cd2c59-1565-4260-a695-65464f06cbd0",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "App Consent Audit",
            "subTarget": "ConsentApp",
            "style": "link"
          }
        ]
      },
      "name": "links - 2"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Troubleshooting Sign-ins"
            },
            "name": "text - 0"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "value::selected"
              ],
              "parameters": [
                {
                  "id": "13f56671-7604-4427-a4d8-663f3da0cbc5",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 86400000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000,
                        "createdTime": "2018-11-13T19:33:10.162Z",
                        "isInitialTime": false,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      },
                      {
                        "durationMs": 900000,
                        "createdTime": "2018-11-13T19:33:10.164Z",
                        "isInitialTime": false,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      },
                      {
                        "durationMs": 1800000,
                        "createdTime": "2018-11-13T19:33:10.164Z",
                        "isInitialTime": false,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      },
                      {
                        "durationMs": 3600000,
                        "createdTime": "2018-11-13T19:33:10.164Z",
                        "isInitialTime": false,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      },
                      {
                        "durationMs": 14400000,
                        "createdTime": "2018-11-13T19:33:10.164Z",
                        "isInitialTime": false,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      },
                      {
                        "durationMs": 43200000,
                        "createdTime": "2018-11-13T19:33:10.164Z",
                        "isInitialTime": false,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      },
                      {
                        "durationMs": 86400000,
                        "createdTime": "2018-11-13T19:33:10.165Z",
                        "isInitialTime": false,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      },
                      {
                        "durationMs": 172800000,
                        "createdTime": "2018-11-13T19:33:10.166Z",
                        "isInitialTime": false,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      },
                      {
                        "durationMs": 259200000,
                        "createdTime": "2018-11-13T19:33:10.166Z",
                        "isInitialTime": false,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      },
                      {
                        "durationMs": 604800000,
                        "createdTime": "2018-11-13T19:33:10.166Z",
                        "isInitialTime": false,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      },
                      {
                        "durationMs": 1209600000,
                        "createdTime": "2018-11-13T19:33:10.166Z",
                        "isInitialTime": false,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      },
                      {
                        "durationMs": 2592000000,
                        "createdTime": "2018-11-13T19:33:10.167Z",
                        "isInitialTime": false,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      }
                    ],
                    "allowCustom": true
                  }
                },
                {
                  "id": "3b5cc420-8ad8-4523-ba28-a54910756794",
                  "version": "KqlParameterItem/1.0",
                  "name": "Apps",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "SigninLogs\r\n| summarize Count = count() by AppDisplayName\r\n| order by Count desc, AppDisplayName asc\r\n| project Value = AppDisplayName, Label = strcat(AppDisplayName, ' - ', Count, ' sign-ins'), Selected = false\r\n",
                  "crossComponentResources": [
                    "/subscriptions/30b1d708-00cf-49ec-bf4f-fdb3aac12a04/resourceGroups/rg-sent-adv-hunting/providers/Microsoft.OperationalInsights/workspaces/sent-adv-hunting"
                  ],
                  "typeSettings": {
                    "limitSelectTo": 20,
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "*",
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": [
                    "value::all"
                  ]
                },
                {
                  "id": "23f8947f-6002-4953-88e3-6949f7a8603a",
                  "version": "KqlParameterItem/1.0",
                  "name": "Users",
                  "type": 2,
                  "description": "Filter by User Name",
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n| summarize Count = count() by UserDisplayName\r\n| order by Count desc, UserDisplayName asc\r\n| project Value = UserDisplayName, Label = strcat(UserDisplayName, ' - ', Count, ' sign-ins'), Selected = false\r\n",
                  "crossComponentResources": [
                    "/subscriptions/30b1d708-00cf-49ec-bf4f-fdb3aac12a04/resourceGroups/rg-sent-adv-hunting/providers/Microsoft.OperationalInsights/workspaces/sent-adv-hunting"
                  ],
                  "typeSettings": {
                    "limitSelectTo": 20,
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "*",
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": [
                    "value::all"
                  ]
                }
              ],
              "style": "pills",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "name": "parameters - 1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let data = SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n|extend errorCode = Status.errorCode\r\n|extend SigninStatus = case(errorCode == 0, \"Success\", errorCode == 50058, \"Pending action (Interrupts)\",errorCode == 50140, \"Pending action (Interrupts)\", errorCode == 51006, \"Pending action (Interrupts)\", errorCode == 50059, \"Pending action (Interrupts)\",errorCode == 65001, \"Pending action (Interrupts)\", errorCode == 52004, \"Pending action (Interrupts)\", errorCode == 50055, \"Pending action (Interrupts)\", errorCode == 50144, \"Pending action (Interrupts)\", errorCode == 50072, \"Pending action (Interrupts)\", errorCode == 50074, \"Pending action (Interrupts)\", errorCode == 16000, \"Pending action (Interrupts)\", errorCode == 16001, \"Pending action (Interrupts)\", errorCode == 16003, \"Pending action (Interrupts)\", errorCode == 50127, \"Pending action (Interrupts)\", errorCode == 50125, \"Pending action (Interrupts)\", errorCode == 50129, \"Pending action (Interrupts)\", errorCode == 50143, \"Pending action (Interrupts)\", errorCode == 81010, \"Pending action (Interrupts)\", errorCode == 81014, \"Pending action (Interrupts)\", errorCode == 81012 ,\"Pending action (Interrupts)\", \"Failure\");\r\ndata\r\n| summarize Count = count() by SigninStatus\r\n| join kind = fullouter (datatable(SigninStatus:string)['Success', 'Pending action (Interrupts)', 'Failure']) on SigninStatus\r\n| project SigninStatus = iff(SigninStatus == '', SigninStatus1, SigninStatus), Count = iff(SigninStatus == '', 0, Count)\r\n| join kind = inner (data\r\n    | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SigninStatus)\r\n    on SigninStatus\r\n| project-away SigninStatus1, TimeGenerated\r\n| extend Status = SigninStatus\r\n| union (\r\n    data \r\n    | summarize Count = count() \r\n    | extend jkey = 1\r\n    | join kind=inner (data\r\n        | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\r\n        | extend jkey = 1) on jkey\r\n    | extend SigninStatus = 'All Sign-ins', Status = '*'    \r\n)\r\n| order by Count desc\r\n\r\n\r\n\r\n",
              "size": 3,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "SigninStatus",
                  "formatter": 1,
                  "formatOptions": {
                    "showIcon": true
                  }
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "blue",
                    "showIcon": true
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Trend",
                  "formatter": 9,
                  "formatOptions": {
                    "min": 0,
                    "palette": "blue",
                    "showIcon": true
                  }
                },
                "showBorder": false
              }
            },
            "name": "query - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n| extend ErrorCode = tostring(Status.errorCode) \r\n| extend FailureReason = tostring(Status.failureReason) \r\n| where ErrorCode !in (\"0\",\"50058\",\"50148\",\"50140\", \"51006\", \"50059\", \"65001\", \"52004\", \"50055\", \"50144\",\"50072\", \"50074\", \"16000\",\"16001\", \"16003\", \"50127\", \"50125\", \"50129\",\"50143\", \"81010\", \"81014\", \"81012\") \r\n|summarize errCount = count() by ErrorCode, tostring(FailureReason)| sort by errCount\r\n|project ['‚ùå Error Code'] = ErrorCode, ['Reason']= FailureReason, ['Error Count'] = toint(errCount)",
              "size": 1,
              "showAnalytics": true,
              "title": "Summary of top errors",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "‚ùå Error Code",
              "exportParameterName": "ErrorCode",
              "exportDefaultValue": "*",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Error Count",
                    "formatter": 8,
                    "formatOptions": {
                      "min": 0,
                      "palette": "orange",
                      "showIcon": true
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "67",
            "showPin": true,
            "name": "query - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n| extend ErrorCode = tostring(Status.errorCode) \r\n| extend FailureReason = tostring(Status.failureReason) \r\n| where ErrorCode !in (\"0\",\"50058\",\"50148\",\"50140\", \"51006\", \"50059\", \"65001\", \"52004\", \"50055\", \"50144\",\"50072\", \"50074\", \"16000\",\"16001\", \"16003\", \"50127\", \"50125\", \"50129\",\"50143\", \"81010\", \"81014\", \"81012\") \r\n| where '{ErrorCode}' == '*' or '{ErrorCode}' == ErrorCode\r\n| top 200 by TimeGenerated desc\r\n| extend TimeFromNow = now() - TimeGenerated\r\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| project User = UserDisplayName, ['‚ùå Error Code'] = ErrorCode, ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = ErrorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName\r\n\r\n\r\n",
              "size": 1,
              "showAnalytics": true,
              "title": "Sign-ins with errors",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "‚ùå Error Code",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "GenericDetails",
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "App",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Error code",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Result type",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Result signature",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Result description",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Conditional access policies",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Conditional access status",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Operating system",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Browser",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Country or region",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "State",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "City",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Time generated",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "User principal name",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "33",
            "name": "query - 5 - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n| extend ErrorCode = tostring(Status.errorCode) \r\n| extend FailureReason = Status.failureReason \r\n| where ErrorCode in (\"50058\",\"50140\", \"51006\", \"50059\", \"65001\", \"52004\", \"50055\", \"50144\",\"50072\", \"50074\", \"16000\",\"16001\", \"16003\", \"50127\", \"50125\", \"50129\",\"50143\", \"81010\", \"81014\", \"81012\") \r\n|summarize errCount = count() by ErrorCode, tostring(FailureReason)\r\n| sort by errCount\r\n|project ['‚ùå Error Code'] = ErrorCode, ['Reason'] = FailureReason, ['Interrupt Count'] = toint(errCount)",
              "size": 1,
              "showAnalytics": true,
              "title": "Summary of sign-ins waiting on user action",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "‚ùå Error Code",
              "exportParameterName": "InterruptErrorCode",
              "exportDefaultValue": "*",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Interrupt Count",
                    "formatter": 8,
                    "formatOptions": {
                      "min": 0,
                      "palette": "orange"
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "67",
            "showPin": true,
            "name": "query - 7"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs \r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n| extend ErrorCode = tostring(Status.errorCode) \r\n| extend FailureReason = Status.failureReason \r\n| where ErrorCode in (\"50058\",\"50140\", \"51006\", \"50059\", \"65001\", \"52004\", \"50055\", \"50144\",\"50072\", \"50074\", \"16000\",\"16001\", \"16003\", \"50127\", \"50125\", \"50129\",\"50143\", \"81010\", \"81014\", \"81012\") \r\n| where '{InterruptErrorCode}' == '*' or '{InterruptErrorCode}' == ErrorCode\r\n| top 200 by TimeGenerated desc\r\n| extend TimeFromNow = now() - TimeGenerated\r\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| project User = UserDisplayName, ['‚ùå Error Code'] = ErrorCode, ['Sign-in Time'] = TimeAgo, App = AppDisplayName, ['Error code'] = ErrorCode, ['Result type'] = ResultType, ['Result signature'] = ResultSignature, ['Result description'] = ResultDescription, ['Conditional access policies'] = ConditionalAccessPolicies, ['Conditional access status'] = ConditionalAccessStatus, ['Operating system'] = DeviceDetail.operatingSystem, Browser = DeviceDetail.browser, ['Country or region'] = LocationDetails.countryOrRegion, ['State'] = LocationDetails.state, ['City'] = LocationDetails.city, ['Time generated'] = TimeGenerated, Status, ['User principal name'] = UserPrincipalName\r\n\r\n",
              "size": 1,
              "showAnalytics": true,
              "title": "Sign-ins waiting on user action",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "‚ùå Error Code",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "GenericDetails",
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "App",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Error code",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Result type",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Result signature",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Result description",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Conditional access policies",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Conditional access status",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Operating system",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Browser",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Country or region",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "State",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "City",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Time generated",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Status",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "User principal name",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  }
                ],
                "filter": true
              }
            },
            "customWidth": "33",
            "showPin": true,
            "name": "query - 7 - Copy"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "SignInTab"
      },
      "name": "SignInError"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Sign-ins using Conditional Access (Deprecated)"
            },
            "name": "text - 0"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "parameters": [
                {
                  "id": "13f56671-7604-4427-a4d8-663f3da0cbc5",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 1209600000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      }
                    ],
                    "allowCustom": true
                  }
                },
                {
                  "id": "3b5cc420-8ad8-4523-ba28-a54910756794",
                  "version": "KqlParameterItem/1.0",
                  "name": "Apps",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "SigninLogs\r\n| summarize Count = count() by AppDisplayName\r\n| order by Count desc, AppDisplayName asc\r\n| project Value = AppDisplayName, Label = strcat(AppDisplayName, ' - ', Count, ' sign-ins'), Selected = false\r\n",
                  "crossComponentResources": [
                    "{pn_Workspace}"
                  ],
                  "typeSettings": {
                    "limitSelectTo": 20,
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "*",
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": [
                    "value::all"
                  ]
                },
                {
                  "id": "88102190-0f5c-40ea-96a7-d8f735352fab",
                  "version": "KqlParameterItem/1.0",
                  "name": "Users",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n| summarize Count = count() by UserDisplayName\r\n| order by Count desc, UserDisplayName asc\r\n| project Value = UserDisplayName, Label = strcat(UserDisplayName, ' - ', Count, ' sign-ins'), Selected = false\r\n",
                  "crossComponentResources": [
                    "{pn_Workspace}"
                  ],
                  "typeSettings": {
                    "limitSelectTo": 20,
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "*",
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": [
                    "value::all"
                  ]
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let data = SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n|extend CAStatus = case(ConditionalAccessStatus ==\"success\",\"Successful\",\r\n                    ConditionalAccessStatus == \"failure\", \"Failed\",                                     \r\n                    ConditionalAccessStatus == \"notApplied\", \"Not applied\",                                     \r\n                    isempty(ConditionalAccessStatus), \"Not applied\", \r\n                    \"Disabled\")\r\n|mvexpand ConditionalAccessPolicies\r\n|extend CAGrantControlName = tostring(ConditionalAccessPolicies.enforcedGrantControls[0])\r\n|extend CAGrantControl = case(CAGrantControlName contains \"MFA\", \"Require MFA\", \r\n                            CAGrantControlName contains \"Terms of Use\", \"Require Terms of Use\", \r\n                            CAGrantControlName contains \"Privacy\", \"Require Privacy Statement\", \r\n                            CAGrantControlName contains \"Device\", \"Require Device Compliant\", \r\n                            CAGrantControlName contains \"Azure AD Joined\", \"Require Hybird Azure AD Joined Device\", \r\n                            CAGrantControlName contains \"Apps\", \"Require Approved Apps\",\r\n                            \"Other\");\r\ndata\r\n| summarize Count = dcount(Id) by CAStatus\r\n| join kind = inner (data\r\n                    | make-series Trend = dcount(Id) default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by CAStatus\r\n                    ) on CAStatus\r\n| project-away CAStatus1, TimeGenerated\r\n| order by Count desc",
              "size": 3,
              "title": "Conditional access status",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "CAStatus",
                  "formatter": 1,
                  "formatOptions": {
                    "showIcon": true
                  }
                },
                "subtitleContent": {
                  "columnMatch": "Text",
                  "formatter": 1,
                  "formatOptions": {
                    "showIcon": true
                  }
                },
                "leftContent": {
                  "columnMatch": "Count",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "blue",
                    "showIcon": true
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "secondaryContent": {
                  "columnMatch": "Trend",
                  "formatter": 9,
                  "formatOptions": {
                    "palette": "blue",
                    "showIcon": true
                  }
                },
                "showBorder": false
              }
            },
            "name": "query - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let data = SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n|extend errorCode = toint(Status.errorCode)\r\n|extend Reason = tostring(Status.failureReason)\r\n|extend CAStatus = case(ConditionalAccessStatus == \"success\",\"‚úîÔ∏è Success\",                                     \r\n                        ConditionalAccessStatus == \"failure\", \"‚ùå Failure\",                                     \r\n                        ConditionalAccessStatus == \"notApplied\", \"‚ö†Ô∏è Not Applied\",                                     \r\n                        ConditionalAccessStatus == \"\", \"‚ö†Ô∏è Not Applied\", \r\n                        \"üö´ Disabled\")\r\n|mvexpand ConditionalAccessPolicies\r\n|extend CAGrantControlName = tostring(ConditionalAccessPolicies.enforcedGrantControls[0])\r\n|extend CAGrantControl = case(CAGrantControlName contains \"MFA\", \"Require MFA\", \r\n                            CAGrantControlName contains \"Terms of Use\", \"Require Terms of Use\", \r\n                            CAGrantControlName contains \"Privacy\", \"Require Privacy Statement\", \r\n                            CAGrantControlName contains \"Device\", \"Require Device Compliant\", \r\n                            CAGrantControlName contains \"Azure AD Joined\", \"Require Hybird Azure AD Joined Device\", \r\n                            CAGrantControlName contains \"Apps\", \"Require Approved Apps\",\"Other\");\r\ndata\r\n| summarize Count = dcount(Id) by CAStatus, CAGrantControl\r\n| project Id = strcat(CAStatus, '/', CAGrantControl), Name = CAGrantControl, Parent = CAStatus, Count, Type = 'CAGrantControl'\r\n| join kind = inner (data\r\n                    | make-series Trend = dcount(Id) default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by CAStatus, CAGrantControl\r\n                    | project Id = strcat(CAStatus, '/', CAGrantControl), Trend\r\n                    ) on Id\r\n| project-away Id1\r\n| union (data\r\n    | summarize Count = dcount(Id) by CAStatus\r\n    | project Id = CAStatus, Name = CAStatus, Parent = '', Count, Type = 'CAStatus'\r\n    | join kind = inner (data\r\n                        | make-series Trend = dcount(Id) default = 0 on TimeGenerated in range({TimeRange:start}, {TimeRange:end}, {TimeRange:grain}) by CAStatus\r\n                        | project Id = CAStatus, Trend\r\n                        ) on Id\r\n    | project-away Id1)\r\n| order by Count desc",
              "size": 0,
              "showAnalytics": true,
              "title": "Conditional access status",
              "timeContextFromParameter": "TimeRange",
              "exportParameterName": "Detail",
              "exportDefaultValue": "{ \"Name\":\"\", \"Type\":\"*\", \"Parent\":\"*\"}",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Id",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Parent",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Count",
                    "formatter": 8,
                    "formatOptions": {
                      "min": 0,
                      "palette": "blue",
                      "showIcon": true
                    },
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  },
                  {
                    "columnMatch": "Type",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Trend",
                    "formatter": 9,
                    "formatOptions": {
                      "min": 0,
                      "palette": "blue",
                      "showIcon": true
                    }
                  }
                ],
                "hierarchySettings": {
                  "idColumn": "Id",
                  "parentColumn": "Parent",
                  "treeType": 0,
                  "expanderColumn": "Name",
                  "expandTopLevel": true
                }
              }
            },
            "customWidth": "50",
            "showPin": true,
            "name": "query - 7"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let details = dynamic({Detail});\r\nlet data = SigninLogs\r\n|where AppDisplayName in ({Apps}) or '*' in ({Apps})\r\n|where UserDisplayName in ({Users}) or '*' in ({Users})\r\n|extend errorCode = toint(Status.errorCode)\r\n|extend Reason = tostring(Status.failureReason)\r\n|extend CAStatus = case(ConditionalAccessStatus ==\"success\",\"‚úîÔ∏è Success\",                                     \r\n                        ConditionalAccessStatus == \"failure\", \"‚ùå Failure\",                                     \r\n                        ConditionalAccessStatus == \"notApplied\", \"‚ö†Ô∏è Not Applied\",                                     \r\n                        ConditionalAccessStatus == \"\", \"‚ö†Ô∏è Not Applied\", \r\n                        \"üö´ Disabled\")\r\n|mvexpand ConditionalAccessPolicies\r\n|extend CAGrantControlName = tostring(ConditionalAccessPolicies.enforcedGrantControls[0])\r\n|extend CAGrantControl = case(CAGrantControlName contains \"MFA\", \"Require MFA\", \r\n                            CAGrantControlName contains \"Terms of Use\", \"Require Terms of Use\", \r\n                            CAGrantControlName contains \"Privacy\", \"Require Privacy Statement\", \r\n                            CAGrantControlName contains \"Device\", \"Require Device Compliant\", \r\n                            CAGrantControlName contains \"Azure AD Joined\", \"Require Hybird Azure AD Joined Device\", \r\n                            CAGrantControlName contains \"Apps\", \"Require Approved Apps\",\r\n                            \"Other\")\r\n|extend CAGrantControlRank = case(CAGrantControlName contains \"MFA\", 1, \r\n                            CAGrantControlName contains \"Terms of Use\", 2, \r\n                            CAGrantControlName contains \"Privacy\", 3, \r\n                            CAGrantControlName contains \"Device\", 4, \r\n                            CAGrantControlName contains \"Azure AD Joined\", 5, \r\n                            CAGrantControlName contains \"Apps\", 6,\r\n                            7)\r\n| where details.Type == '*' or (details.Type == 'CAStatus' and CAStatus == details.Name) or (details.Type == 'CAGrantControl' and CAGrantControl == details.Name and CAStatus == details.Parent);\r\ndata\r\n| order by CAGrantControlRank desc\r\n| summarize CAGrantControls = make_set(CAGrantControl) by AppDisplayName, CAStatus, TimeGenerated, UserDisplayName\r\n| extend CAGrantControlText = replace(@\",\", \", \", replace(@'\"', @'', replace(@\"\\]\", @\"\", replace(@\"\\[\", @\"\", tostring(CAGrantControls)))))\r\n| extend CAGrantControlSummary = case(array_length(CAGrantControls) > 1, strcat(CAGrantControls[0], ' + ', array_length(CAGrantControls) - 1, ' more'), array_length(CAGrantControls) == 1, tostring(CAGrantControls[0]), 'None')\r\n| top 200 by TimeGenerated desc\r\n| extend TimeFromNow = now() - TimeGenerated\r\n| extend TimeAgo = strcat(case(TimeFromNow < 2m, strcat(toint(TimeFromNow / 1m), ' seconds'), TimeFromNow < 2h, strcat(toint(TimeFromNow / 1m), ' minutes'), TimeFromNow < 2d, strcat(toint(TimeFromNow / 1h), ' hours'), strcat(toint(TimeFromNow / 1d), ' days')), ' ago')\r\n| project Application = AppDisplayName, ['CA Status'] = CAStatus, ['CA Grant Controls'] = CAGrantControlSummary, ['All CA Grant Controls'] = CAGrantControlText, ['Sign-in Time'] = TimeAgo, ['User'] = UserDisplayName",
              "size": 0,
              "showAnalytics": true,
              "title": "Recent sign-ins",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "CA Grant Controls",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "CellDetails",
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "All CA Grant Controls",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "User",
                    "formatter": 5,
                    "formatOptions": {
                      "showIcon": true
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "showPin": true,
            "name": "query - 7 - Copy"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "CAStatus"
      },
      "name": "group - 3"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Conditional Access Gaps and Recommendations\r\n### Update time range and visit sections to view potential Conditional Access Policy gaps\r\n\r\n"
            },
            "name": "text - 0"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "paragraph",
              "links": [
                {
                  "id": "67c9ee13-c838-442c-b9a0-16198a7ef703",
                  "cellValue": "https://docs.microsoft.com/azure/active-directory/conditional-access/best-practices",
                  "linkTarget": "Url",
                  "linkLabel": "here ",
                  "preText": "Click ",
                  "postText": "to learn more about Conditional Access best practices",
                  "style": "link"
                }
              ]
            },
            "name": "links - 8"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "673e5287-c580-493b-adcd-77c638ac032f",
                  "version": "KqlParameterItem/1.0",
                  "name": "time_range",
                  "label": "Time Range",
                  "type": 4,
                  "description": "Select a time range for CA insights",
                  "isRequired": true,
                  "value": {
                    "durationMs": 86400000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      }
                    ],
                    "allowCustom": true
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 7"
          },
          {
            "type": 1,
            "content": {
              "json": "----------------------------------------------------------------------------------------------------"
            },
            "name": "text - 11"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Legacy Authentication -- Learn More",
              "expandable": true,
              "expanded": true,
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Legacy Authentication"
                  },
                  "name": "text - 6"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "#### Microsoft recommends blocking sign-ins using legacy authentication\r\n"
                  },
                  "name": "text - 3"
                },
                {
                  "type": 11,
                  "content": {
                    "version": "LinkItem/1.0",
                    "style": "paragraph",
                    "links": [
                      {
                        "id": "c5736fb8-e64c-4ead-8c76-068309dc41cb",
                        "cellValue": "https://docs.microsoft.com/azure/active-directory/conditional-access/block-legacy-authentication",
                        "linkTarget": "Url",
                        "linkLabel": "here",
                        "preText": "Click",
                        "postText": "to learn more about legacy authentication",
                        "style": "link"
                      }
                    ]
                  },
                  "name": "links - 9"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project ClientAppUsed, ResultType, ConditionalAccessPolicies, UserDisplayName\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where ResultType == 0\r\n| extend filterClientApp = case(ClientAppUsed != \"Browser\" and ClientAppUsed != \"Mobile Apps and Desktop clients\", \"Legacy Authentication\", \"Modern Authentication\")\r\n| summarize count() by UserDisplayName, filterClientApp\r\n| summarize Count = count() by filterClientApp",
                    "size": 1,
                    "title": "Users Signing-In Using Legacy vs. Modern Authentication",
                    "timeContextFromParameter": "time_range",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "piechart"
                  },
                  "customWidth": "50",
                  "name": "query - 4"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project ClientAppUsed, AppDisplayName, ConditionalAccessPolicies, ResultType, UserDisplayName\r\n| where ClientAppUsed != \"Browser\" and ClientAppUsed != \"Mobile Apps and Desktop clients\"\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where ResultType == 0\r\n| summarize count() by UserDisplayName, AppDisplayName\r\n| summarize Count = count() by AppDisplayName ",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Users Using Legacy Authentication by Application",
                    "noDataMessage": "No applications allowing legacy authentication sign-ins for the selected time range",
                    "noDataMessageStyle": 3,
                    "timeContextFromParameter": "time_range",
                    "exportFieldName": "AppDisplayName",
                    "exportParameterName": "app",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "categoricalbar"
                  },
                  "name": "query - 3"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project ClientAppUsed, AppDisplayName, ConditionalAccessPolicies, ResultType, UserDisplayName\r\n| where ClientAppUsed != \"Browser\" and ClientAppUsed != \"Mobile Apps and Desktop clients\"\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where ResultType == 0\r\n| summarize count() by UserDisplayName, AppDisplayName, ClientAppUsed\r\n| project-away count_",
                    "size": 3,
                    "showAnalytics": true,
                    "title": "Select an application and user to learn more",
                    "noDataMessage": "No application sign-ins using legacy authentication within this time frame",
                    "noDataMessageStyle": 3,
                    "timeContextFromParameter": "time_range",
                    "exportedParameters": [
                      {
                        "fieldName": "AppDisplayName",
                        "parameterName": "app"
                      },
                      {
                        "fieldName": "UserDisplayName",
                        "parameterName": "user",
                        "parameterType": 1
                      }
                    ],
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "AppDisplayName",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "ClientAppUsed",
                          "formatter": 5
                        }
                      ],
                      "filter": true,
                      "hierarchySettings": {
                        "treeType": 1,
                        "groupBy": [
                          "AppDisplayName",
                          "ClientAppUsed"
                        ],
                        "expandTopLevel": false
                      }
                    },
                    "sortBy": [],
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "AppDisplayName",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "graphSettings": {
                      "type": 0,
                      "topContent": {
                        "columnMatch": "AppDisplayName",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "Count",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "51",
                  "name": "query - 1"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project UserDisplayName, ClientAppUsed, AppDisplayName, ConditionalAccessPolicies, ResultType, TimeGenerated, CorrelationId, LocationDetails, DeviceDetail\r\n| where ClientAppUsed != \"Browser\" and ClientAppUsed != \"Mobile Apps and Desktop clients\"\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where ResultType == 0\r\n| where AppDisplayName == \"{app}\"\r\n| where UserDisplayName == \"{user}\"\r\n| project TimeGenerated, CorrelationId",
                    "size": 3,
                    "showAnalytics": true,
                    "title": "{user} legacy authentication sign-ins to {app}",
                    "timeContextFromParameter": "time_range",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "gridSettings": {
                      "filter": true
                    },
                    "sortBy": []
                  },
                  "customWidth": "49",
                  "conditionalVisibility": {
                    "parameterName": "app",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "query - 6"
                }
              ]
            },
            "name": "LegacyAuth"
          },
          {
            "type": 1,
            "content": {
              "json": "---------------------------"
            },
            "name": "text - 8"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Unprotected Applications -- Learn More",
              "expandable": true,
              "expanded": true,
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Number of Users Signing In to Applications with Conditional Access Policies Not Applied\r\n##### Microsoft recommends that each sign-in to an application has a Conditional Access Policy applied to it.\r\n"
                  },
                  "name": "text - 2"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project AppDisplayName, ConditionalAccessStatus, Status, ResultType, UserDisplayName\r\n| where ResultType == 0 // sign-in was successful\r\n| where ConditionalAccessStatus == \"notApplied\"\r\n| where Status.additionalDetails != \"MFA requirement satisfied by claim in the token\" and Status.additionalDetails != \"MFA requirement skipped due to remembered device\" // Sign-in was not strong auth\r\n| summarize Count = count() by AppDisplayName, UserDisplayName\r\n| summarize count() by AppDisplayName\r\n\r\n",
                    "size": 0,
                    "timeContextFromParameter": "time_range",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "barchart"
                  },
                  "name": "query - 2"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project AppDisplayName, UserDisplayName, ConditionalAccessStatus, Status, ResultType\r\n| where ResultType == 0 // sign-in was successful\r\n| where ConditionalAccessStatus == \"notApplied\"\r\n| where Status.additionalDetails != \"MFA requirement satisfied by claim in the token\" and Status.additionalDetails != \"MFA requirement skipped due to remembered device\" // Sign-in was not strong auth\r\n| summarize Count = count() by UserDisplayName, AppDisplayName\r\n| order by Count\r\n",
                    "size": 0,
                    "title": "Select an application and user to learn more",
                    "noDataMessage": "No application sign-ins without conditional access coverage in this time frame",
                    "timeContextFromParameter": "time_range",
                    "exportedParameters": [
                      {
                        "fieldName": "AppDisplayName",
                        "parameterName": "App",
                        "parameterType": 1
                      },
                      {
                        "fieldName": "UserDisplayName",
                        "parameterName": "User",
                        "parameterType": 1
                      }
                    ],
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "AppDisplayName",
                          "formatter": 5
                        }
                      ],
                      "filter": true,
                      "hierarchySettings": {
                        "treeType": 1,
                        "groupBy": [
                          "AppDisplayName"
                        ],
                        "expandTopLevel": false
                      }
                    },
                    "sortBy": []
                  },
                  "customWidth": "50",
                  "name": "query - 1"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project AppDisplayName, UserDisplayName, ConditionalAccessStatus, Status, ResultType, TimeGenerated, CorrelationId, OperatingSystem = tostring(DeviceDetail.operatingSystem)\r\n| where ResultType == 0 // sign-in was successful\r\n| where ConditionalAccessStatus == \"notApplied\"\r\n| where AppDisplayName == \"{App}\"\r\n| where UserDisplayName == \"{User}\"\r\n| where Status.additionalDetails != \"MFA requirement satisfied by claim in the token\" and Status.additionalDetails != \"MFA requirement skipped due to remembered device\" // Sign-in was not strong auth\r\n| project TimeGenerated, CorrelationId, OperatingSystem",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "{User} sign-ins to {App} without CA coverage",
                    "timeContextFromParameter": "time_range",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ]
                  },
                  "customWidth": "50",
                  "conditionalVisibilities": [
                    {
                      "parameterName": "App",
                      "comparison": "isNotEqualTo"
                    },
                    {
                      "parameterName": "User",
                      "comparison": "isNotEqualTo"
                    }
                  ],
                  "name": "query - 3"
                }
              ]
            },
            "name": "App Sign-ins"
          },
          {
            "type": 1,
            "content": {
              "json": "---------------------------"
            },
            "name": "text - 9"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Compromised User Sign-ins -- Learn More",
              "expandable": true,
              "expanded": true,
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## High Risk Sign-In Events Bypassing Conditional Access Policies\r\n##### Microsoft recommends blocking all high risk sign-in events, including sign-ins where the user account is known to be compromised."
                  },
                  "name": "text - 1"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project UserDisplayName, ConditionalAccessStatus, RiskLevelDuringSignIn, Status, ResultType\r\n| where ResultType == 0 // sign-in was successful\r\n| where RiskLevelDuringSignIn != \"none\" and RiskLevelDuringSignIn != \"low\" and RiskLevelDuringSignIn != \"medium\"\r\n| where Status.additionalDetails != \"MFA requirement satisfied by claim in the token\" and Status.additionalDetails != \"MFA requirement skipped due to remembered device\" // Sign-in was not strong auth\r\n| summarize Count = count() by UserDisplayName, RiskLevelDuringSignIn\r\n| order by Count desc",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Select a user for additional information",
                    "noDataMessage": "No risky sign-ins without CA policies applied in this time frame",
                    "noDataMessageStyle": 3,
                    "timeContextFromParameter": "time_range",
                    "exportFieldName": "UserDisplayName",
                    "exportParameterName": "user",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Count",
                          "formatter": 8,
                          "formatOptions": {
                            "palette": "red"
                          }
                        }
                      ],
                      "sortBy": [
                        {
                          "itemKey": "RiskLevelDuringSignIn",
                          "sortOrder": 1
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "RiskLevelDuringSignIn",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "customWidth": "50",
                  "name": "query - 0"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project TimeGenerated, ResultType, RiskLevelDuringSignIn, UserDisplayName, Status, DeviceDetail, LocationDetails, AppDisplayName, CorrelationId\r\n| where ResultType == 0 // sign-in was successful\r\n| where RiskLevelDuringSignIn != \"none\"\r\n| where UserDisplayName == \"{user}\"\r\n| where Status.additionalDetails != \"MFA requirement satisfied by claim in the token\" and Status.additionalDetails != \"MFA requirement skipped due to remembered device\" // Sign-in was not MFA\r\n| extend OperatingSystem = case(tostring(DeviceDetail.operatingSystem) == \"\", \"Unknown\", DeviceDetail.operatingSystem)\r\n| project TimeGenerated, AppDisplayName, CorrelationId, tostring(LocationDetails.countryOrRegion), OperatingSystem",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Risky sign-Ins from {user} with no CA policies",
                    "timeContextFromParameter": "time_range",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ]
                  },
                  "customWidth": "50",
                  "conditionalVisibility": {
                    "parameterName": "user",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "query - 2"
                }
              ]
            },
            "name": "group - 4"
          },
          {
            "type": 1,
            "content": {
              "json": "---------------------------"
            },
            "name": "text - 10"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Unprotected Locations -- Learn More",
              "expandable": true,
              "expanded": true,
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Users With No Conditional Access Coverage by Location"
                  },
                  "name": "text - 3"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project UserDisplayName, ConditionalAccessStatus, Status, ResultType, location = tostring(LocationDetails.countryOrRegion)\r\n| where ConditionalAccessStatus == \"notApplied\"\r\n| where Status.additionalDetails != \"MFA requirement satisfied by claim in the token\" and Status.additionalDetails != \"MFA requirement skipped due to remembered device\" // Sign-in was not strong auth\r\n| where ResultType == 0\r\n| summarize count() by location, UserDisplayName\r\n| summarize Count = count() by location\r\n| order by Count desc",
                    "size": 0,
                    "timeContextFromParameter": "time_range",
                    "exportFieldName": "LocationDetails_countryOrRegion",
                    "exportParameterName": "country",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "map",
                    "mapSettings": {
                      "locInfo": "CountryRegion",
                      "locInfoColumn": "location",
                      "sizeSettings": "Count",
                      "sizeAggregation": "Sum",
                      "legendMetric": "Count",
                      "legendAggregation": "Sum",
                      "itemColorSettings": {
                        "nodeColorField": "Count",
                        "colorAggregation": "Sum",
                        "type": "heatmap",
                        "heatmapPalette": "greenRed"
                      }
                    }
                  },
                  "name": "query - 5"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project UserDisplayName, ConditionalAccessStatus, Status, ResultType, LocationDetails\r\n| where ResultType == 0 // sign-in was successful\r\n| where ConditionalAccessStatus == \"notApplied\"\r\n| where Status.additionalDetails != \"MFA requirement satisfied by claim in the token\" and Status.additionalDetails != \"MFA requirement skipped due to remembered device\" // Sign-in was not strong auth\r\n| extend Location = case(tostring(LocationDetails.countryOrRegion) == \"\", \"Unknown\", LocationDetails.countryOrRegion)\r\n| summarize Count = count() by UserDisplayName, Location\r\n| project-away Count\r\n",
                    "size": 3,
                    "title": "Select a country/region to learn more",
                    "timeContextFromParameter": "time_range",
                    "exportedParameters": [
                      {
                        "fieldName": "Location",
                        "parameterName": "country"
                      },
                      {
                        "fieldName": "UserDisplayName",
                        "parameterName": "User",
                        "parameterType": 1
                      },
                      {
                        "parameterType": 1
                      }
                    ],
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Location",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "Count",
                          "formatter": 8,
                          "formatOptions": {
                            "palette": "blue"
                          }
                        },
                        {
                          "columnMatch": "rawLocation",
                          "formatter": 5
                        }
                      ],
                      "hierarchySettings": {
                        "treeType": 1,
                        "groupBy": [
                          "Location"
                        ]
                      },
                      "sortBy": [
                        {
                          "itemKey": "UserDisplayName",
                          "sortOrder": 1
                        }
                      ]
                    },
                    "sortBy": [
                      {
                        "itemKey": "UserDisplayName",
                        "sortOrder": 1
                      }
                    ]
                  },
                  "customWidth": "50",
                  "name": "query - 2"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project LocationDetails, UserDisplayName, ConditionalAccessStatus, AppDisplayName, ResultType, TimeGenerated, CorrelationId\r\n| where ConditionalAccessStatus == \"notApplied\"\r\n| where ResultType == 0 // Sign-in was successful\r\n| extend country = case(\"{country}\" == \"Unknown\", \"\", \"{country}\" != \"Unknown\", \"{country}\", \"{country}\")\r\n| where LocationDetails.countryOrRegion == country\r\n| where UserDisplayName == \"{User}\"\r\n| project TimeGenerated, CorrelationId, AppDisplayName\r\n",
                    "size": 0,
                    "title": "Additional Information",
                    "timeContextFromParameter": "time_range",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Count",
                          "formatter": 8,
                          "formatOptions": {
                            "palette": "blue"
                          }
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "customWidth": "50",
                  "conditionalVisibility": {
                    "parameterName": "country",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "query - 6"
                }
              ]
            },
            "name": "group - 7"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "CAGap"
      },
      "name": "group - 4"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Conditional Access Insights\n"
            },
            "name": "text - 5"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "paragraph",
              "links": [
                {
                  "id": "733e4a57-4e6c-4ded-9541-00c0526043c0",
                  "cellValue": "https://portal.azure.com/?reportonlypolicies=true#blade/Microsoft_AAD_IAM/ConditionalAccessBlade/Policies",
                  "linkTarget": "Url",
                  "linkLabel": "visit the Conditional Access blade.",
                  "preText": "Select a conditional access policy to evaluate its impact. To modify or enforce a policy",
                  "postText": "",
                  "style": "link"
                },
                {
                  "id": "511f8ba8-51dd-4901-b736-99210d47be23",
                  "cellValue": "https://forms.office.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbR-yNf4bujCxMnnpOaB92Gr5UN0Y2TjAxSE1CODY3QzE1OEg2Q0lEQkdPSi4u",
                  "linkTarget": "Url",
                  "linkLabel": "here.",
                  "preText": "Submit private preview feedback ",
                  "postText": "",
                  "style": "link"
                }
              ]
            },
            "name": "Unknown - 11"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "parameters": [
                {
                  "id": "9b8cc3f0-ebab-482e-be6d-903f3e066c99",
                  "version": "KqlParameterItem/1.0",
                  "name": "Policy",
                  "label": "Conditional Access Policy",
                  "type": 2,
                  "isRequired": true,
                  "query": "SigninLogs\r\n| project ConditionalAccessPolicies, CreatedDateTime, ClientAppUsed\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where ClientAppUsed == \"Browser\"\r\n| top 1 by CreatedDateTime\r\n| project-away CreatedDateTime\r\n| mv-expand ConditionalAccessPolicies\r\n| where ConditionalAccessPolicies[\"result\"] !contains \"reportOnly\" and ConditionalAccessPolicies[\"result\"] !contains \"notEnabled\"\r\n| project name = ConditionalAccessPolicies[\"displayName\"]\r\n| project Value = name, Label = strcat(name, ' - (Enabled)'), selected = true, displayOrder = \"1\", group = \"Enabled policies\"\r\n| union (\r\nSigninLogs\r\n| project ConditionalAccessPolicies, CreatedDateTime, ClientAppUsed\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where ClientAppUsed == \"Browser\"\r\n| top 1 by CreatedDateTime\r\n| project-away CreatedDateTime\r\n| mv-expand ConditionalAccessPolicies\r\n| where ConditionalAccessPolicies[\"result\"] contains \"reportOnly\"\r\n| project name = ConditionalAccessPolicies[\"displayName\"]\r\n| project Value = name, Label = strcat(name, ' - (Report-only)'), selected = false, displayOrder = \"2\", group = \"Report-only policies\"\r\n)\r\n| sort by displayOrder asc, Label asc\r\n\r\n",
                  "crossComponentResources": [
                    "{pn_Workspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 1800000
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": null
                },
                {
                  "id": "17196e4b-f291-46a5-9e00-0b5e0d8943e8",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "label": "Time Range",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 86400000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ]
                  }
                },
                {
                  "id": "93cfc5e1-92f3-43a3-aad5-dc7fc507eb57",
                  "version": "KqlParameterItem/1.0",
                  "name": "User",
                  "type": 1,
                  "description": "Default value is All users",
                  "isRequired": true,
                  "value": "All users",
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange"
                },
                {
                  "id": "60a4d33d-0d73-47e8-a32d-6798d0f5730e",
                  "version": "KqlParameterItem/1.0",
                  "name": "App",
                  "type": 1,
                  "description": "Default value is All apps",
                  "isRequired": true,
                  "value": "All apps",
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange"
                },
                {
                  "id": "db042271-d62d-45ee-ab7f-56fef70dc459",
                  "version": "KqlParameterItem/1.0",
                  "name": "unit",
                  "label": "Data view",
                  "type": 2,
                  "description": "Display results by number of users or number of sign-ins",
                  "isRequired": true,
                  "query": "let unit = datatable(label:string,units:string)\r\n[\"users\", \"|\",\r\n \"sign-ins\",\"//\"];\r\nunit \r\n| project Value = units, Label = label",
                  "crossComponentResources": [
                    "{pn_Workspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": "//"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 1"
          },
          {
            "type": 1,
            "content": {
              "json": "## Impact Summary\nHere is the impact of the selected policy in your tenant over the {TimeRange}. \n\nüí° _View summary by number of users or number of sign-ins. Click on a tile to view details below._"
            },
            "name": "text - 5b"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Total\r\nSigninLogs\r\n| where CreatedDateTime {TimeRange:value}\r\n| project ConditionalAccessPolicies, UserDisplayName, AppDisplayName\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| project-away AppDisplayName\r\n| mv-expand ConditionalAccessPolicies\r\n| where ConditionalAccessPolicies[\"displayName\"] == \"{Policy:escape}\"\r\n| project-away ConditionalAccessPolicies\r\n{unit} summarize count() by UserDisplayName\r\n| summarize count()\r\n| extend resultName = \"Total\", unit = case(\"{unit}\" == \"//\", \"sign-ins\",\"users\"), statusCode = 1\r\n//\r\n//\r\n// Number of success/failure/user action required/not applied\r\n| union (\r\nSigninLogs\r\n| where CreatedDateTime {TimeRange:value}\r\n| project ConditionalAccessPolicies, UserDisplayName, AppDisplayName\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| project-away AppDisplayName\r\n| mv-expand ConditionalAccessPolicies\r\n| where ConditionalAccessPolicies[\"displayName\"] == \"{Policy:escape}\"\r\n| extend result = ConditionalAccessPolicies[\"result\"]\r\n| project-away ConditionalAccessPolicies\r\n| extend resultName = case(result == \"success\" or result == \"reportOnlySuccess\", \"Success\", result == \"failure\" or result == \"reportOnlyFailure\", \"Failure\", result == \"interrupt\" or result == \"reportOnlyInterrupted\", \"User action required\", \"Not applied\")\r\n| extend statusCode = case(result == \"success\", 2, result == \"failure\", 3, result == \"interrupt\", 4, 5)\r\n{unit} summarize count() by resultName, UserDisplayName, statusCode\r\n| summarize count() by resultName, statusCode\r\n| extend unit = case(\"{unit}\" == \"//\", \"sign-ins\",\"users\")\r\n)\r\n//\r\n// Case if result count is 0\r\n| join kind = fullouter (\r\n    datatable (resultName:string,statusCode1:string)\r\n    [\"Total\", 1,\r\n     \"Success\", 2,\r\n     \"Failure\", 3,\r\n     \"User action required\", 4,\r\n     \"Not applied\", 5]\r\n) on resultName\r\n| extend resultName = iff(resultName == '', resultName1, resultName), count_ = iff(resultName == '', 0, count_), unit = \"{unit:label}\", statusCode1\r\n| project-away resultName1\r\n| sort by statusCode1 asc",
              "size": 3,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "resultName",
              "exportParameterName": "resultName",
              "exportDefaultValue": "Total",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "resultName",
                  "formatter": 1,
                  "formatOptions": {
                    "showIcon": true
                  }
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto",
                    "showIcon": true
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "secondaryContent": {
                  "columnMatch": "unit",
                  "formatter": 1,
                  "formatOptions": {
                    "showIcon": true
                  }
                },
                "showBorder": true
              }
            },
            "name": "query - 56"
          },
          {
            "type": 1,
            "content": {
              "json": "__________________________________________\r\n## Breakdown per condition and sign-in status\r\nüí° _Click the LogAnalytics icon in the corner of each query to run in a new window._"
            },
            "conditionalVisibility": {
              "parameterName": "statusCode",
              "comparison": "isNotEqualTo",
              "value": "0"
            },
            "name": "text - 14"
          },
          {
            "type": 1,
            "content": {
              "json": "### Device State \r\n{resultName} ({unit:label})"
            },
            "customWidth": "33",
            "conditionalVisibility": {
              "parameterName": "statusCode",
              "comparison": "isNotEqualTo",
              "value": "0"
            },
            "name": "text - 13"
          },
          {
            "type": 1,
            "content": {
              "json": "### Device Platform\r\n{resultName} ({unit:label})"
            },
            "customWidth": "33",
            "conditionalVisibility": {
              "parameterName": "statusCode",
              "comparison": "isNotEqualTo",
              "value": "0"
            },
            "name": "text - 15"
          },
          {
            "type": 1,
            "content": {
              "json": "### Client App\r\n{resultName} ({unit:label})"
            },
            "customWidth": "33",
            "conditionalVisibility": {
              "parameterName": "statusCode",
              "comparison": "isNotEqualTo",
              "value": "0"
            },
            "name": "text - 22"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| where CreatedDateTime{TimeRange:value}\r\n| project ConditionalAccessPolicies, UserDisplayName, AppDisplayName, DeviceDetail\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| project-away AppDisplayName\r\n| mv-expand ConditionalAccessPolicies\r\n| where ConditionalAccessPolicies[\"displayName\"] == \"{Policy:escape}\"\r\n| extend result = ConditionalAccessPolicies[\"result\"]\r\n| project-away ConditionalAccessPolicies\r\n| extend filterResult = case(\"{resultName}\" == \"Total\",\"successfailureinterruptreportOnlySuccessreportOnlyFailurereportOnlyInterruptedreportOnlyNotAppliednotEnabled\", \"{resultName}\" == \"Success\", \"successreportOnlySuccess\", \"{resultName}\" == \"Failure\", \"failurereportOnlyFailure\", \"{resultName}\" == \"User action required\", \"interruptreportOnlyInterrupted\",\"notAppliedreportOnlyNotAppliednotEnabled\")\r\n| where filterResult contains result\r\n| extend deviceState = case(DeviceDetail[\"trustType\"] == \"\", \"Unmanaged\", DeviceDetail[\"trustType\"])\r\n{unit} summarize count() by UserDisplayName, deviceState\r\n| summarize count() by deviceState\r\n\r\n",
              "size": 1,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "deviceState",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              }
            },
            "customWidth": "33",
            "name": "success users device state"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| where CreatedDateTime {TimeRange:value}\r\n| project ConditionalAccessPolicies, UserDisplayName, AppDisplayName, DeviceDetail\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| project-away AppDisplayName\r\n| mv-expand ConditionalAccessPolicies\r\n| where ConditionalAccessPolicies[\"displayName\"] == \"{Policy:escape}\"\r\n| extend result = ConditionalAccessPolicies[\"result\"]\r\n| project-away ConditionalAccessPolicies\r\n| extend filterResult = case(\"{resultName}\" == \"Total\",\"successfailureinterruptreportOnlySuccessreportOnlyFailurereportOnlyInterruptedreportOnlyNotAppliednotEnabled\", \"{resultName}\" == \"Success\", \"successreportOnlySuccess\", \"{resultName}\" == \"Failure\", \"failurereportOnlyFailure\", \"{resultName}\" == \"User action required\", \"interruptreportOnlyInterrupted\",\"notAppliedreportOnlyNotAppliednotEnabled\")\r\n| where filterResult contains result\r\n| extend device = tostring(DeviceDetail[\"operatingSystem\"])\r\n{unit} summarize count() by UserDisplayName, device\r\n| summarize count() by device\r\n\r\n\r\n",
              "size": 1,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "deviceState",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              }
            },
            "customWidth": "33",
            "name": "success users device state - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| where CreatedDateTime {TimeRange:value}\r\n| project ConditionalAccessPolicies, UserDisplayName, AppDisplayName, ClientAppUsed\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| project-away AppDisplayName\r\n| mv-expand ConditionalAccessPolicies\r\n| where ConditionalAccessPolicies[\"displayName\"] == \"{Policy:escape}\"\r\n| extend result = ConditionalAccessPolicies[\"result\"]\r\n| project-away ConditionalAccessPolicies\r\n| extend filterResult = case(\"{resultName}\" == \"Total\",\"successfailureinterruptreportOnlySuccessreportOnlyFailurereportOnlyInterruptedreportOnlyNotAppliednotEnabled\", \"{resultName}\" == \"Success\", \"successreportOnlySuccess\", \"{resultName}\" == \"Failure\", \"failurereportOnlyFailure\", \"{resultName}\" == \"User action required\", \"interruptreportOnlyInterrupted\",\"notAppliedreportOnlyNotAppliednotEnabled\")\r\n| where filterResult contains result\r\n{unit} summarize count() by UserDisplayName, ClientAppUsed\r\n| summarize count() by ClientAppUsed",
              "size": 1,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "deviceState",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              }
            },
            "customWidth": "33",
            "name": "success users device state - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "### Sign-in Risk\r\n{resultName} ({unit:label})"
            },
            "customWidth": "33",
            "conditionalVisibility": {
              "parameterName": "statusCode",
              "comparison": "isNotEqualTo",
              "value": "0"
            },
            "name": "text - 23"
          },
          {
            "type": 1,
            "content": {
              "json": "### Location\r\n{resultName} ({unit:label})"
            },
            "customWidth": "33",
            "conditionalVisibility": {
              "parameterName": "statusCode",
              "comparison": "isNotEqualTo",
              "value": "0"
            },
            "name": "text - 16"
          },
          {
            "type": 1,
            "content": {
              "json": "### Applications\n{resultName} ({unit:label})\n"
            },
            "customWidth": "33",
            "conditionalVisibility": {
              "parameterName": "statusCode",
              "comparison": "isNotEqualTo",
              "value": "0"
            },
            "name": "text - 6"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| where CreatedDateTime {TimeRange:value}\r\n| project ConditionalAccessPolicies, UserDisplayName, AppDisplayName, RiskLevelDuringSignIn\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| project-away AppDisplayName\r\n| mv-expand ConditionalAccessPolicies\r\n| where ConditionalAccessPolicies[\"displayName\"] == \"{Policy:escape}\"\r\n| extend result = ConditionalAccessPolicies[\"result\"]\r\n| project-away ConditionalAccessPolicies\r\n| extend filterResult = case(\"{resultName}\" == \"Total\",\"successfailureinterruptreportOnlySuccessreportOnlyFailurereportOnlyInterruptedreportOnlyNotAppliednotEnabled\", \"{resultName}\" == \"Success\", \"successreportOnlySuccess\", \"{resultName}\" == \"Failure\", \"failurereportOnlyFailure\", \"{resultName}\" == \"User action required\", \"interruptreportOnlyInterrupted\",\"notAppliedreportOnlyNotAppliednotEnabled\")\r\n| where filterResult contains result\r\n{unit} summarize count() by UserDisplayName, RiskLevelDuringSignIn\r\n| summarize count() by RiskLevelDuringSignIn",
              "size": 1,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "piechart",
              "tileSettings": {
                "showBorder": false,
                "titleContent": {
                  "columnMatch": "deviceState",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              }
            },
            "customWidth": "33",
            "name": "success users device state - Copy - Copy - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| where CreatedDateTime {TimeRange:value}\r\n| project ConditionalAccessPolicies, UserDisplayName, AppDisplayName, location = tostring(LocationDetails.city)\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| project-away AppDisplayName\r\n| mv-expand ConditionalAccessPolicies\r\n| where ConditionalAccessPolicies[\"displayName\"] == \"{Policy:escape}\"\r\n| extend result = ConditionalAccessPolicies[\"result\"]\r\n| project-away ConditionalAccessPolicies\r\n| extend filterResult = case(\"{resultName}\" == \"Total\",\"successfailureinterruptreportOnlySuccessreportOnlyFailurereportOnlyInterruptedreportOnlyNotAppliednotEnabled\", \"{resultName}\" == \"Success\", \"successreportOnlySuccess\", \"{resultName}\" == \"Failure\", \"failurereportOnlyFailure\", \"{resultName}\" == \"User action required\", \"interruptreportOnlyInterrupted\",\"notAppliedreportOnlyNotAppliednotEnabled\")\r\n| where filterResult contains result\r\n{unit} summarize count() by UserDisplayName, location\r\n| summarize Count = count() by location\r\n| sort by Count desc",
              "size": 1,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "location",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "green",
                      "showIcon": true,
                      "aggregation": "Count"
                    }
                  },
                  {
                    "columnMatch": "Count",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "blue",
                      "showIcon": true,
                      "aggregation": "Max"
                    }
                  },
                  {
                    "columnMatch": "-- Group By --",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "green",
                      "showIcon": true
                    }
                  }
                ]
              }
            },
            "customWidth": "33",
            "name": "success users location"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| where CreatedDateTime {TimeRange:value}\r\n| project ConditionalAccessPolicies, UserDisplayName, AppDisplayName\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| mv-expand ConditionalAccessPolicies\r\n| where ConditionalAccessPolicies[\"displayName\"] == \"{Policy:escape}\"\r\n| extend result = ConditionalAccessPolicies[\"result\"]\r\n| project-away ConditionalAccessPolicies\r\n| extend filterResult = case(\"{resultName}\" == \"Total\",\"successfailureinterruptreportOnlySuccessreportOnlyFailurereportOnlyInterruptedreportOnlyNotAppliednotEnabled\", \"{resultName}\" == \"Success\", \"successreportOnlySuccess\", \"{resultName}\" == \"Failure\", \"failurereportOnlyFailure\", \"{resultName}\" == \"User action required\", \"interruptreportOnlyInterrupted\",\"notAppliedreportOnlyNotAppliednotEnabled\")\r\n| where filterResult contains result\r\n{unit} summarize count() by UserDisplayName, AppDisplayName\r\n| summarize Count = count() by AppDisplayName\r\n| sort by Count desc",
              "size": 1,
              "showAnalytics": true,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "location",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "green",
                      "showIcon": true,
                      "aggregation": "Count"
                    }
                  },
                  {
                    "columnMatch": "Count",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "blue",
                      "showIcon": true,
                      "aggregation": "Max"
                    }
                  },
                  {
                    "columnMatch": "-- Group By --",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "green",
                      "showIcon": true
                    }
                  }
                ]
              }
            },
            "customWidth": "33",
            "name": "success users location - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "____________________________________________\r\n## Sign-in Details\r\nüí° _To investigate sign-in details of a specific user, filter by username at the top of the workbook_"
            },
            "conditionalVisibility": {
              "parameterName": "statusCode",
              "comparison": "isNotEqualTo",
              "value": "0"
            },
            "name": "text - 22b"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| where CreatedDateTime {TimeRange:value}\r\n| project ConditionalAccessPolicies, UserDisplayName, AppDisplayName\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| project-away AppDisplayName\r\n| mv-expand ConditionalAccessPolicies\r\n| where ConditionalAccessPolicies[\"displayName\"] == \"{Policy:escape}\"\r\n| extend result = ConditionalAccessPolicies[\"result\"]\r\n| project-away ConditionalAccessPolicies\r\n| extend filterResult = case(\"{resultName}\" == \"Total\",\"successfailureinterruptreportOnlySuccessreportOnlyFailurereportOnlyInterruptedreportOnlyNotAppliednotEnabled\", \"{resultName}\" == \"Success\", \"successreportOnlySuccess\", \"{resultName}\" == \"Failure\", \"failurereportOnlyFailure\", \"{resultName}\" == \"User action required\", \"interruptreportOnlyInterrupted\",\"notAppliedreportOnlyNotAppliednotEnabled\")\r\n| where filterResult contains result\r\n| summarize Count = count() by UserDisplayName\r\n| sort by Count desc",
              "size": 0,
              "showAnalytics": true,
              "title": "User sign-in count",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "UserDisplayName",
              "exportParameterName": "user",
              "exportDefaultValue": "*",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Count",
                    "formatter": 8,
                    "formatOptions": {
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "Signins",
                    "formatter": 8,
                    "formatOptions": {
                      "showIcon": true
                    }
                  }
                ],
                "rowLimit": 10000,
                "filter": true
              }
            },
            "customWidth": "30",
            "name": "query - 21"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SigninLogs\r\n| where CreatedDateTime {TimeRange:value}\r\n| project ConditionalAccessPolicies, CreatedDateTime, UserDisplayName, AppDisplayName, CorrelationId, Status\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where '{user:escape}' == '*' or '{user:escape}' == UserDisplayName\r\n| where \"{User:escape}\" == \"All users\" or UserDisplayName contains \"{User:escape}\"\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName contains \"{App:escape}\"\r\n| mv-expand ConditionalAccessPolicies\r\n| where ConditionalAccessPolicies[\"displayName\"] == \"{Policy:escape}\"\r\n| extend result = ConditionalAccessPolicies[\"result\"], failureReason = tostring(Status[\"failureReason\"])\r\n| project-away ConditionalAccessPolicies\r\n| extend filterResult = case(\"{resultName}\" == \"Total\",\"successfailureinterruptreportOnlySuccessreportOnlyFailurereportOnlyInterruptedreportOnlyNotAppliednotEnabled\", \"{resultName}\" == \"Success\", \"successreportOnlySuccess\", \"{resultName}\" == \"Failure\", \"failurereportOnlyFailure\", \"{resultName}\" == \"User action required\", \"interruptreportOnlyInterrupted\",\"notAppliedreportOnlyNotAppliednotEnabled\")\r\n| where filterResult contains result\r\n| project CreatedDateTime, UserDisplayName, AppDisplayName, result, CorrelationId",
              "size": 0,
              "showAnalytics": true,
              "title": "Sign-in events",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Signins",
                    "formatter": 0,
                    "formatOptions": {
                      "showIcon": true,
                      "aggregation": "Count"
                    }
                  },
                  {
                    "columnMatch": "combinedResult",
                    "formatter": 0,
                    "formatOptions": {
                      "showIcon": true,
                      "aggregation": "Count"
                    }
                  }
                ],
                "rowLimit": 1000,
                "filter": true
              }
            },
            "customWidth": "70",
            "name": "query - 22"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "CondAccess"
      },
      "name": "group - 5"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Sign-ins using Legacy Authentication"
            },
            "customWidth": "100",
            "name": "text - 0"
          },
          {
            "type": 1,
            "content": {
              "json": "Microsoft recommends blocking sign-ins from legacy authentication protocols. "
            },
            "name": "text - 4"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "paragraph",
              "links": [
                {
                  "id": "15ade074-f44c-4d1f-a4d7-6dd1aa7eb243",
                  "cellValue": "https://docs.microsoft.com/azure/active-directory/conditional-access/block-legacy-authentication",
                  "linkTarget": "Url",
                  "linkLabel": "here",
                  "preText": "Click",
                  "postText": "to learn more about blocking legacy authentication",
                  "style": "link"
                }
              ]
            },
            "name": "links - 9"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "13f56671-7604-4427-a4d8-663f3da0cbc5",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 86400000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      }
                    ],
                    "allowCustom": true
                  },
                  "timeContextFromParameter": "TimeRange"
                },
                {
                  "id": "3b5cc420-8ad8-4523-ba28-a54910756794",
                  "version": "KqlParameterItem/1.0",
                  "name": "Apps",
                  "type": 1,
                  "description": "Default value is All apps",
                  "isRequired": true,
                  "value": "All apps",
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange"
                },
                {
                  "id": "15200934-c2dd-488b-be37-8b038696deee",
                  "version": "KqlParameterItem/1.0",
                  "name": "Users",
                  "type": 1,
                  "description": "Default value is All users",
                  "isRequired": true,
                  "value": "All users",
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange"
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 1"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project ClientAppUsed, ResultType, ConditionalAccessPolicies, UserDisplayName, AppDisplayName, TimeGenerated\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where \"{Users:escape}\" == \"All users\" or UserDisplayName contains \"{Users:escape}\"\r\n| where \"{Apps:escape}\" == \"All apps\" or AppDisplayName contains \"{Apps:escape}\"\r\n| where ResultType == 0\r\n| extend filterClientApp = case(ClientAppUsed != \"Browser\" and ClientAppUsed != \"Mobile Apps and Desktop clients\", \"Legacy Authentication\", \"Modern Authentication\")\r\n| summarize count() by UserDisplayName, filterClientApp, bin(TimeGenerated, 1h)\r\n| summarize count() by filterClientApp, bin(TimeGenerated, 1h)\r\n| order by TimeGenerated",
                    "size": 1,
                    "aggregation": 5,
                    "title": "Users Signed-in on Legacy vs. Modern Authentication",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "linechart",
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "Modern Authentication",
                          "color": "blue"
                        },
                        {
                          "seriesName": "Legacy Authentication",
                          "color": "orange"
                        }
                      ]
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 4"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project ClientAppUsed, ResultType, ConditionalAccessPolicies, UserDisplayName, AppDisplayName\r\n| where \"{Users:escape}\" == \"All users\" or UserDisplayName contains \"{Users:escape}\"\r\n| where \"{Apps:escape}\" == \"All apps\" or AppDisplayName contains \"{Apps:escape}\"\r\n| where ClientAppUsed != \"Browser\" and ClientAppUsed != \"Mobile Apps and Desktop clients\"\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where ResultType == 0\r\n| summarize count() by UserDisplayName, ClientAppUsed\r\n| summarize Count = count() by ClientAppUsed",
                    "size": 1,
                    "title": "Legacy Authentication Client Apps Used",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "piechart"
                  },
                  "customWidth": "50",
                  "name": "query - 4b"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "--------------------------------------------------------------------------------------------------"
                  },
                  "name": "text - 5"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project ClientAppUsed, AppDisplayName, ConditionalAccessPolicies, ResultType, UserDisplayName\r\n| where ClientAppUsed != \"Browser\" and ClientAppUsed != \"Mobile Apps and Desktop clients\"\r\n| where \"{Users:escape}\" == \"All users\" or UserDisplayName contains \"{Users:escape}\"\r\n| where \"{Apps:escape}\" == \"All apps\" or AppDisplayName contains \"{Apps:escape}\"\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where ResultType == 0\r\n| summarize count() by UserDisplayName, AppDisplayName\r\n| summarize Count = count() by AppDisplayName ",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Users Using Legacy Authentication by Application",
                    "noDataMessage": "No applications allowing legacy authentication sign-ins for the selected time range",
                    "noDataMessageStyle": 3,
                    "timeContextFromParameter": "TimeRange",
                    "exportFieldName": "AppDisplayName",
                    "exportParameterName": "app",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "categoricalbar"
                  },
                  "name": "query - 3"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project ClientAppUsed, AppDisplayName, ConditionalAccessPolicies, ResultType, UserDisplayName\r\n| where \"{Users:escape}\" == \"All users\" or UserDisplayName contains \"{Users:escape}\"\r\n| where \"{Apps:escape}\" == \"All apps\" or AppDisplayName contains \"{Apps:escape}\"\r\n| where ClientAppUsed != \"Browser\" and ClientAppUsed != \"Mobile Apps and Desktop clients\"\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where ResultType == 0\r\n| summarize count() by UserDisplayName, AppDisplayName, ClientAppUsed\r\n| project-away count_",
                    "size": 3,
                    "showAnalytics": true,
                    "title": "Select an application and user",
                    "noDataMessage": "No application sign-ins using legacy authentication within this time frame",
                    "noDataMessageStyle": 3,
                    "timeContextFromParameter": "TimeRange",
                    "exportedParameters": [
                      {
                        "fieldName": "AppDisplayName",
                        "parameterName": "app"
                      },
                      {
                        "fieldName": "UserDisplayName",
                        "parameterName": "user",
                        "parameterType": 1
                      }
                    ],
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "AppDisplayName",
                          "formatter": 5
                        },
                        {
                          "columnMatch": "ClientAppUsed",
                          "formatter": 5
                        }
                      ],
                      "filter": true,
                      "hierarchySettings": {
                        "treeType": 1,
                        "groupBy": [
                          "AppDisplayName",
                          "ClientAppUsed"
                        ],
                        "expandTopLevel": false
                      },
                      "labelSettings": [
                        {
                          "columnId": "UserDisplayName",
                          "label": "User"
                        },
                        {
                          "columnId": "AppDisplayName",
                          "label": "Application"
                        },
                        {
                          "columnId": "ClientAppUsed",
                          "label": "Client App"
                        }
                      ]
                    },
                    "sortBy": [],
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "AppDisplayName",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "graphSettings": {
                      "type": 0,
                      "topContent": {
                        "columnMatch": "AppDisplayName",
                        "formatter": 1
                      },
                      "centerContent": {
                        "columnMatch": "Count",
                        "formatter": 1,
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "33",
                  "name": "query - 1"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| project UserDisplayName, ClientAppUsed, AppDisplayName, ConditionalAccessPolicies, ResultType, TimeGenerated, CorrelationId, LocationDetails, DeviceDetail\r\n| where ClientAppUsed != \"Browser\" and ClientAppUsed != \"Mobile Apps and Desktop clients\"\r\n| where \"{Users:escape}\" == \"All users\" or UserDisplayName contains \"{Users:escape}\"\r\n| where \"{Apps:escape}\" == \"All apps\" or AppDisplayName contains \"{Apps:escape}\"\r\n| where ConditionalAccessPolicies != \"[]\"\r\n| where ResultType == 0\r\n| where AppDisplayName == \"{app}\"\r\n| where UserDisplayName == \"{user}\"\r\n| project TimeGenerated, CorrelationId",
                    "size": 3,
                    "showAnalytics": true,
                    "title": "{user} legacy authentication sign-ins to {app}",
                    "timeContextFromParameter": "TimeRange",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "gridSettings": {
                      "filter": true,
                      "labelSettings": [
                        {
                          "columnId": "TimeGenerated",
                          "label": "Time"
                        },
                        {
                          "columnId": "CorrelationId",
                          "label": "Correlation ID"
                        }
                      ]
                    },
                    "sortBy": []
                  },
                  "customWidth": "65",
                  "conditionalVisibility": {
                    "parameterName": "app",
                    "comparison": "isNotEqualTo"
                  },
                  "name": "query - 6"
                }
              ]
            },
            "name": "LegacyAuth"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "LegacyAuth"
      },
      "name": "group - 6"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Identity Protection Risk Analysis \n"
            },
            "customWidth": "60",
            "name": "text - 5"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "14270858-14b9-4fa7-8375-d7d583fcfc9f",
                  "version": "KqlParameterItem/1.0",
                  "name": "Guide",
                  "type": 10,
                  "isRequired": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n {\"value\": \"On\", \"label\": \"On\", \"selected\":true},\r\n {\"value\": \"Off\", \"label\": \"Off\"}\r\n]",
                  "value": "Off"
                },
                {
                  "id": "7bb4cbcc-f0d2-44b5-a82f-565ad66bf987",
                  "version": "KqlParameterItem/1.0",
                  "name": "Time",
                  "type": 4,
                  "isRequired": true,
                  "value": {
                    "durationMs": 2592000000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ],
                    "allowCustom": true
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "100",
            "name": "parameters - 24 - Copy - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "## Guide to using this workbook\r\n\r\nIdentity Protection is a tool that allows organizations to accomplish three key tasks:\r\n\r\n\t1. Automate the detection and remediation of identity-based risks.\r\n\t2. Investigate risks using data in the portal.\r\n\t3. Export risk detection data to your SIEM.\r\n\r\nIdentity Protection uses the learnings Microsoft has acquired from their position in organizations with Azure AD, the consumer space with Microsoft Accounts, and in gaming with Xbox to protect your users. Microsoft analyses 6.5 trillion signals per day to identify and protect customers from threats.\r\n\r\nThe signals generated by and fed to Identity Protection, can be further fed into tools like Conditional Access to make access decisions, or fed back to a security information and event management (SIEM) tool for further investigation based on your organization's enforced policies.... [Learn more](https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/overview-identity-protection).\r\n\r\n\r\n### Workbook parameters \r\n\t‚Ä¢ Time range: Select how long back the report will load. Longer time ranges may not load for large tenants\r\n\r\n\t‚Ä¢ Workspace: Select the Log Analytics workspace you want to use. \r\n\r\n\r\n",
              "style": "success"
            },
            "conditionalVisibility": {
              "parameterName": "Guide",
              "comparison": "isEqualTo",
              "value": "On"
            },
            "name": "Getting started"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 12,
                  "content": {
                    "version": "NotebookGroup/1.0",
                    "groupType": "editable",
                    "items": [
                      {
                        "type": 1,
                        "content": {
                          "json": "## Heatmap of Risk Risk Detections"
                        },
                        "name": "text - 23"
                      },
                      {
                        "type": 1,
                        "content": {
                          "json": "Map location is based on longitude and latiude data. Size of the circles are based on number of risk detections. Color of circles are based on the Weighted Risk = Number of Detections x Weight\r\n\r\nWeight: High Risk = 10, Medium Risk = 5, Low Risk = 1\r\n\r\nLower risk circles are yellow and higher risk circles are red.\r\n\r\n",
                          "style": "info"
                        },
                        "name": "text - 2"
                      },
                      {
                        "type": 3,
                        "content": {
                          "version": "KqlItem/1.0",
                          "query": "AADUserRiskEvents\r\n| where UserDisplayName != \"\"\r\n| extend ParseLocation = parse_json(Location)\r\n| extend City = iff(ParseLocation.city == '', 'Unknown', tostring(ParseLocation.city))\r\n| extend State = iff(ParseLocation.state == '', 'Unknown', tostring(ParseLocation.state))\r\n| extend GeoCoord = ParseLocation.geoCoordinates\r\n| extend ParseGeoCoord = parse_json(GeoCoord)\r\n| extend Latitude = ParseGeoCoord.latitude\r\n| extend Longitude = ParseGeoCoord.longitude\r\n| extend LowRiskWeight = iff(RiskLevel == \"low\", 1, 0)\r\n| extend MedRiskWeight = iff(RiskLevel == \"medium\", 5, 0)\r\n| extend HighRiskWeight = iff(RiskLevel == \"high\", 10, 0)\r\n| extend TotalRiskWeight = LowRiskWeight + MedRiskWeight + HighRiskWeight\r\n| project UserDisplayName,RiskLevel, Location, Latitude, Longitude, City, State, TotalRiskWeight\r\n| summarize Count = count() by UserDisplayName, tostring(Latitude), tostring(Longitude), City, State, TotalRiskWeight\r\n//| summarize LocationCount = count() by tostring(Latitude)\r\n| sort by Count desc",
                          "size": 3,
                          "showAnalytics": true,
                          "timeContextFromParameter": "Time",
                          "showExportToExcel": true,
                          "queryType": 0,
                          "resourceType": "microsoft.operationalinsights/workspaces",
                          "crossComponentResources": [
                            "{pn_Workspace}"
                          ],
                          "visualization": "map",
                          "mapSettings": {
                            "locInfo": "LatLong",
                            "latitude": "Latitude",
                            "longitude": "Longitude",
                            "sizeSettings": "Count",
                            "sizeAggregation": "Sum",
                            "labelSettings": "City",
                            "legendMetric": "Count",
                            "numberOfMetrics": 50,
                            "legendAggregation": "Sum",
                            "itemColorSettings": {
                              "nodeColorField": "TotalRiskWeight",
                              "colorAggregation": "Count",
                              "type": "heatmap",
                              "heatmapPalette": "yellowOrangeRed"
                            }
                          }
                        },
                        "showPin": false,
                        "name": "query - 25 - Copy"
                      }
                    ]
                  },
                  "name": "group - 17"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "## Offline vs Real-Time Risk Detections"
                  },
                  "name": "text - 4"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "Real-Time detections may not show up in reporting for five to ten minutes. Offline detections may not show up in reporting for two to twenty-four hours.",
                    "style": "info"
                  },
                  "name": "text - 17 - Copy"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AADUserRiskEvents\r\n//|summarize RiskEvents = count () by bin (TimeGenerated, 1h)\r\n|where IpAddress != ''\r\n| summarize count() by bin (TimeGenerated, 1h), DetectionTimingType",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Hourly Risk Detections - Offline vs. Real Time",
                    "timeContextFromParameter": "Time",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "barchart",
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "RiskEvents",
                          "color": "gray"
                        },
                        {
                          "seriesName": "high",
                          "label": "High",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "medium",
                          "label": "Medium",
                          "color": "orange"
                        },
                        {
                          "seriesName": "low",
                          "label": "Low",
                          "color": "yellow"
                        },
                        {
                          "seriesName": "none",
                          "label": "None",
                          "color": "green"
                        },
                        {
                          "seriesName": "offline",
                          "label": "Offline",
                          "color": "lightBlue"
                        },
                        {
                          "seriesName": "realtime",
                          "label": "Real-Time",
                          "color": "pink"
                        }
                      ]
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 25 - Copy"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AADUserRiskEvents\r\n//|summarize RiskEvents = count () by bin (TimeGenerated, 1h)\r\n|where IpAddress != ''\r\n| summarize count() by bin (TimeGenerated, 1h), DetectionTimingType",
                    "size": 3,
                    "showAnalytics": true,
                    "title": "Total Count - Offline vs. Real Time",
                    "timeContextFromParameter": "Time",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "RiskEvents",
                          "color": "gray"
                        },
                        {
                          "seriesName": "high",
                          "label": "High",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "medium",
                          "label": "Medium",
                          "color": "orange"
                        },
                        {
                          "seriesName": "low",
                          "label": "Low",
                          "color": "yellow"
                        },
                        {
                          "seriesName": "none",
                          "label": "None",
                          "color": "green"
                        },
                        {
                          "seriesName": "offline",
                          "label": "Offline",
                          "color": "lightBlue"
                        },
                        {
                          "seriesName": "realtime",
                          "label": "Real-Time",
                          "color": "pink"
                        }
                      ]
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 25 - Copy - Copy"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "The offline risk events are those that cannot be remediated via a sign in risk policy, and are important for admins to investigate/turn on risky users policy to remediate\r\n",
                    "style": "warning"
                  },
                  "conditionalVisibility": {
                    "parameterName": "Guide",
                    "comparison": "isEqualTo",
                    "value": "On"
                  },
                  "name": "text - 28"
                }
              ]
            },
            "name": "group - 13"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Risk Detection Trends"
                  },
                  "customWidth": "100",
                  "name": "text - 5b"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "483c5e61-6d4b-408d-9fd1-d9bf7edd6b73",
                        "version": "KqlParameterItem/1.0",
                        "name": "DetectionTimingType",
                        "type": 2,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "value": [
                          "value::all"
                        ],
                        "typeSettings": {
                          "additionalResourceOptions": [
                            "value::all"
                          ],
                          "showDefault": false
                        },
                        "jsonData": "[\r\n { \"value\":\"offline\", \"label\":\"Offline\" },\r\n { \"value\":\"realtime\", \"label\":\"Real-Time\", \"selected\":true }\r\n]",
                        "defaultValue": "value::all"
                      },
                      {
                        "id": "2aa046f2-df65-4560-a7e4-021ce814d3ed",
                        "version": "KqlParameterItem/1.0",
                        "name": "riskLevel",
                        "label": "RiskLevel",
                        "type": 2,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "value": [
                          "value::all"
                        ],
                        "typeSettings": {
                          "additionalResourceOptions": [
                            "value::all"
                          ],
                          "showDefault": false
                        },
                        "jsonData": "[\r\n {\"value\":\"high\", \"label\":\"High\" },\r\n { \"value\":\"medium\", \"label\":\"Medium\" },\r\n { \"value\":\"low\", \"label\":\"Low\"},\r\n { \"value\":\"none\", \"label\":\"None\", \"selected\":true }\r\n]",
                        "defaultValue": "value::all"
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "customWidth": "75",
                  "name": "parameters - 24 - Copy - Copy - Copy"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AADUserRiskEvents\r\n|where IpAddress != ''\r\n| extend riskLevel = case(RiskLevel == \"\", \"none\", RiskLevel)\r\n| where DetectionTimingType in ({DetectionTimingType}) or '*' in ({DetectionTimingType})\r\n| where RiskLevel in ({riskLevel}) or '*' in ({riskLevel})\r\n| summarize count() by bin (TimeGenerated, 1h), riskLevel",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Hourly Risk Detections by Level",
                    "timeContextFromParameter": "Time",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "timechart",
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "RiskEvents",
                          "color": "gray"
                        },
                        {
                          "seriesName": "high",
                          "label": "High",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "medium",
                          "label": "Medium",
                          "color": "orange"
                        },
                        {
                          "seriesName": "low",
                          "label": "Low",
                          "color": "yellow"
                        },
                        {
                          "seriesName": "none",
                          "label": "None",
                          "color": "green"
                        }
                      ]
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 25"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AADUserRiskEvents\r\n|where IpAddress != ''\r\n| extend riskLevel = case(RiskLevel == \"\", \"none\", RiskLevel)\r\n| where DetectionTimingType in ({DetectionTimingType}) or '*' in ({DetectionTimingType})\r\n| where RiskLevel in ({riskLevel}) or '*' in ({riskLevel})\r\n| summarize count() by bin (TimeGenerated, 1h), riskLevel\r\n|sort by riskLevel desc\r\n",
                    "size": 3,
                    "showAnalytics": true,
                    "title": "Total Count by Risk Level",
                    "timeContextFromParameter": "Time",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "medium",
                          "label": "Medium",
                          "color": "orange"
                        },
                        {
                          "seriesName": "high",
                          "label": "High",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "low",
                          "label": "Low",
                          "color": "yellow"
                        }
                      ]
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 25 - Copy - Copy - Copy"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AADUserRiskEvents\r\n|where IpAddress != ''\r\n| extend riskLevel = case(RiskLevel == \"\", \"none\", RiskLevel)\r\n| where DetectionTimingType in ({DetectionTimingType}) or '*' in ({DetectionTimingType})\r\n| where RiskLevel in ({riskLevel}) or '*' in ({riskLevel})\r\n|summarize RiskEvents = count () by bin (TimeGenerated, 1h), RiskEventType",
                    "size": 0,
                    "showAnalytics": true,
                    "title": "Hourly Risk Detections Event Type",
                    "timeContextFromParameter": "Time",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "barchart",
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "newCountry",
                          "label": "New Country",
                          "color": "turquoise"
                        },
                        {
                          "seriesName": "unfamiliarFeatures",
                          "label": "Unfamiliar Features",
                          "color": "green"
                        },
                        {
                          "seriesName": "riskyIPAddress",
                          "label": "Risky IP Address",
                          "color": "blue"
                        },
                        {
                          "seriesName": "passwordSpray",
                          "label": "Password Spray",
                          "color": "magenta"
                        },
                        {
                          "seriesName": "adminConfirmedUserCompromised",
                          "label": "Confirmed User Compromise",
                          "color": "red"
                        },
                        {
                          "seriesName": "anonymizedIPAddress",
                          "label": "Anonymized IP Address",
                          "color": "pink"
                        }
                      ]
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 25 - Copy"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "\r\nAADUserRiskEvents\r\n|where IpAddress != ''\r\n| extend riskLevel = case(RiskLevel == \"\", \"none\", RiskLevel)\r\n| where DetectionTimingType in ({DetectionTimingType}) or '*' in ({DetectionTimingType})\r\n| where RiskLevel in ({riskLevel}) or '*' in ({riskLevel})\r\n|project RiskEventType, UserDisplayName\r\n|extend riskEvent = case(RiskEventType == \"\", \"blank\", RiskEventType)\r\n|summarize count() by riskEvent\r\n|sort by riskEvent desc\r\n",
                    "size": 3,
                    "showAnalytics": true,
                    "title": "Total Count by Risk Event Type",
                    "timeContextFromParameter": "Time",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "newCountry",
                          "label": "New Country",
                          "color": "turquoise"
                        },
                        {
                          "seriesName": "unfamiliarFeatures",
                          "label": "Unfamiliar Features",
                          "color": "green"
                        },
                        {
                          "seriesName": "riskyIPAddress",
                          "label": "Risky IP Address",
                          "color": "blue"
                        },
                        {
                          "seriesName": "passwordSpray",
                          "label": "Password Spray",
                          "color": "magenta"
                        },
                        {
                          "seriesName": "adminConfirmedUserCompromised",
                          "label": "Confirmed User Compromise",
                          "color": "red"
                        }
                      ]
                    }
                  },
                  "customWidth": "50",
                  "showPin": true,
                  "name": "query - 25 - Copy - Copy"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "Risk Event Types can include new country, unfamiliar events, anonymized IP Address, admin confirmed user compromise, password spray or risky IP Address.",
                    "style": "info"
                  },
                  "name": "text - 17"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AADUserRiskEvents\r\n|where IpAddress != ''\r\n| extend riskLevel = case(RiskLevel == \"\", \"none\", RiskLevel)\r\n| where DetectionTimingType in ({DetectionTimingType}) or '*' in ({DetectionTimingType})\r\n| where RiskLevel in ({riskLevel}) or '*' in ({riskLevel})\r\n| summarize TotalCount= count(), HighRiskCount = countif(riskLevel == \"high\"), MediumRiskCount = countif(riskLevel == \"medium\"), LowRiskCount = countif(riskLevel == \"low\"), NoRiskCount = countif(riskLevel==\"none\") by UserDisplayName\r\n| sort by HighRiskCount, MediumRiskCount, LowRiskCount desc\r\n",
                    "size": 3,
                    "title": "Count of Risk Detections by User",
                    "timeContextFromParameter": "Time",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "rowLimit": 10
                    },
                    "sortBy": [],
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "IpAddress",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "50",
                  "showPin": true,
                  "name": "query - 29 - Copy - Copy - Copy",
                  "styleSettings": {
                    "margin": "10"
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AADUserRiskEvents\r\n|where IpAddress != ''\r\n| extend riskLevel = case(RiskLevel == \"\", \"none\", RiskLevel)\r\n| where DetectionTimingType in ({DetectionTimingType}) or '*' in ({DetectionTimingType})\r\n| where RiskLevel in ({riskLevel}) or '*' in ({riskLevel})\r\n| summarize TotalCount= count(), HighRiskCount = countif(riskLevel == \"high\"), MediumRiskCount = countif(riskLevel == \"medium\"), LowRiskCount = countif(riskLevel == \"low\"), NoRiskCount = countif(riskLevel == \"none\") by IpAddress\r\n|sort by HighRiskCount, MediumRiskCount, LowRiskCount desc",
                    "size": 0,
                    "title": "Risk Detections by IP Address",
                    "timeContextFromParameter": "Time",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "rowLimit": 10
                    },
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "IpAddress",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "Count",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "50",
                  "showPin": true,
                  "name": "query - 29 - Copy - Copy - Copy - Copy",
                  "styleSettings": {
                    "margin": "10"
                  }
                }
              ]
            },
            "name": "group - 19"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "# Risky Users\r\nA user risk represents the probability that a given identity or account is compromised.\r\n\r\nThese risks are calculated offline using Microsoft's internal and external threat intelligence sources including security researchers, law enforcement professionals, security teams at Microsoft, and other trusted sources.\r\n"
                  },
                  "name": "text - 5"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "81337f3c-7ed4-4a93-a0ec-eca3fcbf358a",
                        "version": "KqlParameterItem/1.0",
                        "name": "RiskDetail",
                        "type": 2,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "value": [
                          "value::all"
                        ],
                        "typeSettings": {
                          "additionalResourceOptions": [
                            "value::all"
                          ],
                          "showDefault": false
                        },
                        "jsonData": "[\r\n { \"value\":\"none\", \"label\":\"None\" },\r\n { \"value\":\"userPassedMFADrivenByRiskBasedPolicy\", \"label\":\"UserPassedMFAbyRiskBasedPolicies\" },\r\n { \"value\":\"userPerformedSecuredPasswordReset\", \"label\":\"UserPerformedSecuredPasswordReset\"},\r\n {\"value\":\"aiConfirmedSigninSafe\", \"label\": \"AIConfirmedSigninSafe\"},\r\n {\"value\":\"adminDismissedAllRiskForUser\", \"label\": \"AdminDismissedAllRiskForUser\", \"selected\": true }\r\n]",
                        "timeContext": {
                          "durationMs": 2592000000
                        },
                        "timeContextFromParameter": "Time",
                        "defaultValue": "value::all"
                      },
                      {
                        "id": "76beea00-bcf6-4881-bd9d-2caa7a3fb038",
                        "version": "KqlParameterItem/1.0",
                        "name": "RiskLevel",
                        "type": 2,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "value": [
                          "value::all"
                        ],
                        "typeSettings": {
                          "additionalResourceOptions": [
                            "value::all"
                          ],
                          "showDefault": false
                        },
                        "jsonData": "[\r\n { \"value\":\"high\", \"label\":\"High\"},\r\n { \"value\":\"medium\", \"label\":\"Medium\"},\r\n { \"value\":\"low\", \"label\":\"Low\"},\r\n { \"value\": \"none\", \"label\":\"None\",\"selected\":true}\r\n]",
                        "timeContext": {
                          "durationMs": 2592000000
                        },
                        "timeContextFromParameter": "Time",
                        "defaultValue": "value::all"
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "customWidth": "50",
                  "name": "parameters - 6",
                  "styleSettings": {
                    "margin": "50"
                  }
                },
                {
                  "type": 1,
                  "content": {
                    "json": "To reduce the number of risky users with no action taken on them, [enable user risk policies for automatic remediation](https://go.microsoft.com/fwlink/?linkid=2171421)",
                    "style": "info"
                  },
                  "customWidth": "50",
                  "name": "text - 7"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AADRiskyUsers\r\n| where RiskDetail in ({RiskDetail}) or '*' in ({RiskDetail})\r\n| where RiskLevel in ({RiskLevel}) or '*' in ({RiskLevel})\r\n |summarize count(RiskLevel) by bin(TimeGenerated,1d), RiskLevel\r\n\r\n",
                    "size": 3,
                    "title": "Daily Count of Users by Risk Level",
                    "color": "turquoise",
                    "timeContextFromParameter": "Time",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "barchart",
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "low",
                          "label": "Low",
                          "color": "yellow"
                        },
                        {
                          "seriesName": "none",
                          "label": "None",
                          "color": "green"
                        },
                        {
                          "seriesName": "high",
                          "label": "High",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "medium",
                          "label": "Medium",
                          "color": "orange"
                        },
                        {
                          "seriesName": "hidden",
                          "label": "Hidden",
                          "color": "gray"
                        }
                      ]
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 3 - Copy"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "\r\nAADRiskyUsers\r\n| where RiskDetail in ({RiskDetail}) or '*' in ({RiskDetail})\r\n| where RiskLevel in ({RiskLevel}) or '*' in ({RiskLevel})\r\n| summarize count() by RiskDetail",
                    "size": 2,
                    "title": "Action taken on Risky Users",
                    "timeContextFromParameter": "Time",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "piechart",
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "none",
                          "label": "None",
                          "color": "gray"
                        },
                        {
                          "seriesName": "hidden",
                          "label": "Hidden",
                          "color": "grayBlue"
                        },
                        {
                          "seriesName": "adminConfirmedUserCompromised",
                          "label": "Admin Confirmed",
                          "color": "redDark"
                        },
                        {
                          "seriesName": "adminDismissedAllRiskForUser",
                          "label": "Admin Dismissed",
                          "color": "turquoise"
                        },
                        {
                          "seriesName": "userPerformedSecuredPasswordReset",
                          "label": "User Performed Password Reset",
                          "color": "purple"
                        }
                      ]
                    }
                  },
                  "customWidth": "50",
                  "name": "query - 14"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AADRiskyUsers\r\n//| where RiskDetail in ({RiskDetail}) or '*' in ({RiskDetail})\r\n//| where RiskLevel in ({RiskLevel}) or '*' in ({RiskLevel})\r\n| where RiskLevel == 'high'\r\n| project TimeGenerated,UserDisplayName, RiskLevel, RiskDetail\r\n| order by TimeGenerated",
                    "size": 3,
                    "title": "High Risk Users by Time Generated",
                    "color": "red",
                    "timeContextFromParameter": "Time",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "rowLimit": 20
                    }
                  },
                  "customWidth": "55",
                  "showPin": true,
                  "name": "query - 17 - Copy",
                  "styleSettings": {
                    "showBorder": true
                  }
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "//let startTime = ago(90d);\r\n//let endTime = now();\r\nlet noRisk = AADRiskyUsers\r\n//| where TimeGenerated between (ago(14d) .. ago(8d))\r\n| where RiskLevel == 'low' or RiskLevel == 'none'\r\n| summarize by Id;\r\nlet highRisk = AADRiskyUsers\r\n//| where TimeGenerated between (ago(7d).. now())\r\n//| where UserDisplayName in (noRisk)\r\n| where RiskLevel == 'high' or RiskLevel == 'medium'\r\n| summarize by Id;\r\nAADRiskyUsers\r\n|where Id in (noRisk) and Id in (highRisk)\r\n|summarize by RiskLastUpdatedDateTime, UserDisplayName, RiskLevel, RiskDetail\r\n| order by RiskLastUpdatedDateTime\r\n",
                    "size": 3,
                    "title": "Users with changes in Risk Level",
                    "showExportToExcel": true,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ]
                  },
                  "customWidth": "45",
                  "showPin": true,
                  "name": "query - 3",
                  "styleSettings": {
                    "showBorder": true
                  }
                }
              ]
            },
            "name": "group - 18"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Summary"
                  },
                  "name": "text - 34"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AADUserRiskEvents\r\n//| summarize buildschema(Location)\r\n| where IpAddress != ''\r\n| extend ParseLocation = parse_json(Location)\r\n| extend CountryOrRegion = iff(ParseLocation.countryOrRegion == '', 'Unknown', tostring(ParseLocation.countryOrRegion))\r\n| extend GeoCoord = ParseLocation.geoCoordinates\r\n| extend ParseGeoCoord = parse_json(GeoCoord)\r\n| extend Latitude = ParseGeoCoord.latitude\r\n| extend Longitude = ParseGeoCoord.longitude\r\n| extend LowRiskWeight = iff(RiskLevel == \"low\", 1, 0)\r\n| extend MedRiskWeight = iff(RiskLevel == \"medium\", 5, 0)\r\n| extend HighRiskWeight = iff(RiskLevel == \"high\", 10, 0)\r\n| extend TotalRiskWeight = LowRiskWeight + MedRiskWeight + HighRiskWeight\r\n| project UserDisplayName,RiskLevel, Location, Latitude, Longitude, CountryOrRegion, RiskEventType, IpAddress, DetectionTimingType, TotalRiskWeight\r\n| summarize by UserDisplayName, CountryOrRegion, tostring(Latitude), tostring(Longitude), IpAddress, RiskLevel, RiskEventType, DetectionTimingType, TotalRiskWeight\r\n//| summarize LocationCount = count() by tostring(Latitude)\r\n| sort by TotalRiskWeight\r\n",
                    "size": 3,
                    "title": "Summary of Risk Detections by Risk Level",
                    "timeContextFromParameter": "Time",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "table",
                    "gridSettings": {
                      "rowLimit": 20
                    },
                    "mapSettings": {
                      "locInfo": "LatLong",
                      "latitude": "Latitude",
                      "longitude": "Longitude",
                      "sizeSettings": "Count",
                      "sizeAggregation": "Sum",
                      "labelSettings": "CountryOrRegion",
                      "legendMetric": "Count",
                      "numberOfMetrics": 10,
                      "legendAggregation": "Sum",
                      "itemColorSettings": {
                        "nodeColorField": "RiskLevel",
                        "colorAggregation": "Count",
                        "type": "heatmap",
                        "heatmapPalette": "greenRed"
                      }
                    }
                  },
                  "customWidth": "100",
                  "name": "query - 25 - Copy - Copy"
                }
              ]
            },
            "name": "group - 17"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AADRiskyUsers\r\n| project UserDisplayName, RiskLevel, RiskDetail, RiskState, CorrelationId, TenantId\r\n| order by RiskLevel",
              "size": 3,
              "title": "Summary of Risky Users by Risk Level",
              "color": "red",
              "timeContextFromParameter": "Time",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "rowLimit": 20
              }
            },
            "customWidth": "100",
            "showPin": true,
            "name": "query - 17"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "IdProt"
      },
      "name": "group - 7"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Authentication Methods Activity"
            },
            "customWidth": "70",
            "name": "text - 0"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Interactive sign-ins protected with MFA"
                  },
                  "name": "text - 2"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "5fffe1ff-63f8-45b4-9ca7-5a03f0125e68",
                        "version": "KqlParameterItem/1.0",
                        "name": "TimeRange",
                        "label": "Date",
                        "type": 4,
                        "isRequired": true,
                        "value": {
                          "durationMs": 1209600000
                        },
                        "typeSettings": {
                          "selectableValues": [
                            {
                              "durationMs": 86400000
                            },
                            {
                              "durationMs": 172800000
                            },
                            {
                              "durationMs": 259200000
                            },
                            {
                              "durationMs": 604800000
                            },
                            {
                              "durationMs": 1209600000
                            },
                            {
                              "durationMs": 2419200000
                            },
                            {
                              "durationMs": 2592000000
                            }
                          ]
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "11bb8a85-d4b4-47c7-8b6f-e37da60d4f28",
                        "version": "KqlParameterItem/1.0",
                        "name": "App",
                        "type": 1,
                        "value": "All apps",
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "label": "Application"
                      },
                      {
                        "id": "73fbb561-3df3-4194-86f9-714ab45f1534",
                        "version": "KqlParameterItem/1.0",
                        "name": "FactorsRequired",
                        "label": "Factors Required",
                        "type": 2,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "value": [
                          "singleFactorAuthentication",
                          "multiFactorAuthentication"
                        ],
                        "typeSettings": {
                          "additionalResourceOptions": []
                        },
                        "jsonData": "[\r\n    {\"value\": \"singleFactorAuthentication\", \"label\": \"Single-factor authentication\", \"group\": \"Single-factor authentication\"},\r\n    {\"value\": \"multiFactorAuthentication\", \"label\": \"Multi-factor authentication\", \"group\": \"Multi-factor authentication\"}\r\n]"
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "parameters - 3"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| where TimeGenerated {TimeRange:value}\r\n| summarize arg_max(TimeGenerated, *) by CorrelationId\r\n| where \"{App:escape}\" == \"All apps\" or AppDisplayName has \"{App:escape}\"\r\n| where \"{FactorsRequired}\" has AuthenticationRequirement\r\n| project AuthenticationRequirement, TimeGenerated\r\n| summarize count() by AuthenticationRequirement, bin(TimeGenerated, 1d)",
                    "size": 0,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "areachart",
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "singleFactorAuthentication",
                          "label": "Single-factor authentication",
                          "color": "yellow"
                        },
                        {
                          "seriesName": "multiFactorAuthentication",
                          "label": "Multi-factor authentication",
                          "color": "blueDark"
                        }
                      ]
                    }
                  },
                  "name": "query - 1"
                }
              ]
            },
            "customWidth": "50",
            "name": "group - 6"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Usage by authentication method"
                  },
                  "name": "text - 1"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "7fb6491e-4130-4be7-ac5d-d20f1539285b",
                        "version": "KqlParameterItem/1.0",
                        "name": "TimeRange",
                        "label": "Date",
                        "type": 4,
                        "isRequired": true,
                        "value": {
                          "durationMs": 604800000
                        },
                        "typeSettings": {
                          "selectableValues": [
                            {
                              "durationMs": 300000
                            },
                            {
                              "durationMs": 900000
                            },
                            {
                              "durationMs": 1800000
                            },
                            {
                              "durationMs": 3600000
                            },
                            {
                              "durationMs": 14400000
                            },
                            {
                              "durationMs": 43200000
                            },
                            {
                              "durationMs": 86400000
                            },
                            {
                              "durationMs": 172800000
                            },
                            {
                              "durationMs": 259200000
                            },
                            {
                              "durationMs": 604800000
                            },
                            {
                              "durationMs": 1209600000
                            },
                            {
                              "durationMs": 2419200000
                            },
                            {
                              "durationMs": 2592000000
                            }
                          ]
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "2c5d1b67-b8c9-47d3-a9bc-fcd389bcad31",
                        "version": "KqlParameterItem/1.0",
                        "name": "Methods",
                        "type": 2,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "value": [
                          "value::all"
                        ],
                        "typeSettings": {
                          "additionalResourceOptions": [
                            "value::all"
                          ],
                          "showDefault": false
                        },
                        "jsonData": "[\r\n    {\"value\": \"Password\", \"label\": \"Password\"},\r\n    {\"value\": \"Text message\", \"label\": \"Text message\"},\r\n    {\"value\": \"Mobile app notification\", \"label\": \"Mobile app notification\"},\r\n    {\"value\": \"Mobile app verification code\", \"label\": \"Mobile app verification code\"},\r\n    {\"value\": \"Phone call (Authentication phone)\", \"label\": \"Phone call\"},\r\n    {\"value\": \"Passwordless phone sign-in\", \"label\": \"Passwordless phone sign-in\"},\r\n    {\"value\": \"WindowsHelloForBusiness\", \"label\": \"Windows Hello for Business\"},\r\n    {\"value\": \"TemporaryAccessPass\", \"label\": \"Temporary Access Pass\"},\r\n    {\"value\": \"Sms\", \"label\": \"SMS Sign-in\"},\r\n    {\"value\": \"OATH hardware token\", \"label\": \"OATH hardware token\"},\r\n    {\"value\": \"fido\", \"label\": \"FIDO token\"}\r\n]",
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "parameters - 2"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| where TimeGenerated {TimeRange:value}\r\n| summarize arg_max(TimeGenerated, *) by CorrelationId\r\n| project AuthenticationDetails\r\n| where AuthenticationDetails has \"authenticationMethod\"\r\n| extend AuthenticationDetails = parse_json(AuthenticationDetails)\r\n| mv-expand AuthenticationDetails\r\n| where isnotempty(AuthenticationDetails.authenticationMethod)\r\n| project method = case(tostring(AuthenticationDetails.authenticationMethod) == \"PHS\", \"Password\", tostring(AuthenticationDetails.authenticationMethod) == \"PHS, StagedRollout\", \"Password\", tostring(AuthenticationDetails.authenticationMethod) == \"CloudOnlyPassword\", \"Password\", tostring(AuthenticationDetails.authenticationMethod) == \"PTA\", \"Password\", tostring(AuthenticationDetails.authenticationMethod))\r\n| where \"{Methods}\" has method\r\n| summarize count() by method\r\n",
                    "size": 0,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "barchart",
                    "tileSettings": {
                      "showBorder": false,
                      "titleContent": {
                        "columnMatch": "method",
                        "formatter": 1
                      },
                      "leftContent": {
                        "columnMatch": "count_",
                        "formatter": 12,
                        "formatOptions": {
                          "palette": "auto"
                        },
                        "numberFormat": {
                          "unit": 17,
                          "options": {
                            "maximumSignificantDigits": 3,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    },
                    "chartSettings": {
                      "xAxis": "method"
                    }
                  },
                  "name": "query - 2"
                }
              ]
            },
            "customWidth": "50",
            "name": "group - 3"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Number of password resets and account unlocks"
                  },
                  "name": "text - 4"
                },
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "parameters": [
                      {
                        "id": "901aed2f-3a72-448c-a8fe-55696b6597c2",
                        "version": "KqlParameterItem/1.0",
                        "name": "TimeRange",
                        "label": "Date",
                        "type": 4,
                        "isRequired": true,
                        "value": {
                          "durationMs": 1209600000
                        },
                        "typeSettings": {
                          "selectableValues": [
                            {
                              "durationMs": 86400000
                            },
                            {
                              "durationMs": 172800000
                            },
                            {
                              "durationMs": 259200000
                            },
                            {
                              "durationMs": 604800000
                            },
                            {
                              "durationMs": 1209600000
                            },
                            {
                              "durationMs": 2419200000
                            },
                            {
                              "durationMs": 2592000000
                            }
                          ]
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "aa824fc7-0dbb-4e27-9298-c466d9c73388",
                        "version": "KqlParameterItem/1.0",
                        "name": "Activity",
                        "type": 2,
                        "isRequired": true,
                        "multiSelect": true,
                        "quote": "'",
                        "delimiter": ",",
                        "query": "AuditLogs\r\n| where TimeGenerated > ago(14d)\r\n| where LoggedByService == \"Self-service Password Management\"\r\n| summarize by OperationName",
                        "crossComponentResources": [
                          "{pn_Workspace}"
                        ],
                        "typeSettings": {
                          "additionalResourceOptions": [
                            "value::all"
                          ],
                          "showDefault": false
                        },
                        "queryType": 0,
                        "resourceType": "microsoft.operationalinsights/workspaces",
                        "value": [
                          "value::all"
                        ]
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "parameters - 6"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "AuditLogs\r\n| where TimeGenerated {TimeRange:value}\r\n| where LoggedByService == \"Self-service Password Management\"\r\n| where \"{Activity}\" has OperationName\r\n| summarize count() by bin(TimeGenerated, 1d), OperationName",
                    "size": 0,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "barchart",
                    "chartSettings": {
                      "xSettings": {
                        "numberFormatSettings": {
                          "unit": 0,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      },
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 0,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      }
                    }
                  },
                  "name": "query - 5"
                }
              ]
            },
            "customWidth": "50",
            "name": "group - 8"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 1,
                  "content": {
                    "json": "## Failure rate by authentication method (last 30 days)"
                  },
                  "name": "text - 4"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "SigninLogs\r\n| where TimeGenerated > ago(30d)\r\n| summarize arg_max(TimeGenerated, *) by CorrelationId\r\n| project TimeGenerated, CorrelationId, UserDisplayName, AuthenticationDetails, Status\r\n| where AuthenticationDetails has \"authenticationMethod\"\r\n| extend AuthenticationDetails = parse_json(AuthenticationDetails)\r\n| mv-expand AuthenticationDetails\r\n| where isnotempty(AuthenticationDetails.authenticationMethod)\r\n| project method = case(tostring(AuthenticationDetails.authenticationMethod) == \"PHS\", \"Password\", tostring(AuthenticationDetails.authenticationMethod) == \"PHS, StagedRollout\", \"Password\", tostring(AuthenticationDetails.authenticationMethod) == \"CloudOnlyPassword\", \"Password\", tostring(AuthenticationDetails.authenticationMethod) == \"PTA\", \"Password\", tostring(AuthenticationDetails.authenticationMethod)), succeeded = AuthenticationDetails.succeeded\r\n| summarize success = countif(succeeded == true), failure = countif(succeeded == false) by method\r\n| project method, failureRate = (failure * 1.0) / ((failure + success) * 1.0)\r\n| sort by failureRate desc",
                    "size": 0,
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "crossComponentResources": [
                      "{pn_Workspace}"
                    ],
                    "visualization": "barchart",
                    "chartSettings": {
                      "seriesLabelSettings": [
                        {
                          "seriesName": "Text message",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "CloudOnlyPassword",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "Mobile app notification",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "<empty>",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "PHS",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "WindowsHelloForBusiness",
                          "color": "redBright"
                        },
                        {
                          "color": "redBright"
                        },
                        {
                          "seriesName": "Mobile app verification code",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "Fido",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "Password",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "Phone call (Authentication phone)",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "Passwordless phone sign-in",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "PHS, StagedRollout",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "RemoteNGC",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "Phone call (Alternate authentication phone)",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "Phone call (Office phone)",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "TemporaryAccessPass",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "Sms",
                          "color": "redBright"
                        },
                        {
                          "seriesName": "Other",
                          "color": "redBright"
                        }
                      ],
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 0,
                          "options": {
                            "style": "percent",
                            "useGrouping": true,
                            "maximumFractionDigits": 2
                          }
                        }
                      }
                    }
                  },
                  "name": "query - 3 - Copy"
                }
              ]
            },
            "customWidth": "50",
            "name": "group - 6"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "AuthMethod"
      },
      "name": "group - 8"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## App Consent Audit"
            },
            "name": "Title",
            "styleSettings": {
              "margin": "15px 0 0 0"
            }
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "parameters": [
                {
                  "id": "f4d0d58a-e35f-4659-a490-5da142c9a6d2",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "label": "Time Range",
                  "type": 4,
                  "value": {
                    "durationMs": 2592000000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ],
                    "allowCustom": true
                  }
                },
                {
                  "id": "6b6b0bb3-667f-4fb8-9911-3b7f115c89ff",
                  "version": "KqlParameterItem/1.0",
                  "name": "UserName",
                  "label": "User Name",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "AuditLogs\r\n| where OperationName contains \"Consent\"\r\n// user name \r\n| extend initby = parse_json(InitiatedBy) | extend userinfo1 = initby.user | extend userinfo2 = parse_json(userinfo1) \r\n| extend username = userinfo2.userPrincipalName\r\n// app name \r\n| extend tr = parse_json(TargetResources) | mvexpand tr | extend appname = tostring(tr.displayName)\r\n| extend mp = tr.modifiedProperties | mvexpand mp\r\n| extend actinfo = mp.displayName\r\n// consent and scope information \r\n| extend value1 = parse_json(mp) | extend val1 = value1.newValue\r\n| where actinfo == \"ConsentAction.Permissions\"\r\n| parse val1 with * \"ResourceId:\" Resourceid1 \", ConsentType: \" ConsentType \", Scope:\" Scope \"]\" * \r\n| extend Scope1 = split(Scope, \" \")\r\n| mvexpand Scope1 \r\n| where Scope1 != \"\"\r\n| project OperationName , username, appname, actinfo, Resourceid1, ConsentType, Scope1, CorrelationId \r\n| project username = tostring(username) \r\n| distinct username\r\n| sort by username",
                  "crossComponentResources": [
                    "{pn_Workspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "*",
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": [
                    "value::all"
                  ]
                },
                {
                  "id": "c5bb7341-72dd-479b-b001-c58652ac709b",
                  "version": "KqlParameterItem/1.0",
                  "name": "AppName1",
                  "label": "App Name",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "(SigninLogs\r\n| extend corrIDTime = strcat(CorrelationId, TimeGenerated)\r\n| extend ConditionalAccessPolicies = tostring(ConditionalAccessPolicies)\r\n| extend DeviceDetail = tostring(DeviceDetail) \r\n| extend LocationDetails = tostring(LocationDetails) \r\n| extend Status = tostring(Status)\r\n| distinct AppDisplayName)\r\n| union \r\n\r\n(AuditLogs\r\n| where OperationName contains \"Consent\"\r\n// user name \r\n| extend initby = parse_json(InitiatedBy) | extend userinfo1 = initby.user | extend userinfo2 = parse_json(userinfo1) \r\n| extend username = userinfo2.userPrincipalName\r\n// app name \r\n| extend tr = parse_json(TargetResources) | mvexpand tr | extend appname = tostring(tr.displayName)\r\n| extend mp = tr.modifiedProperties | mvexpand mp\r\n| extend actinfo = mp.displayName\r\n// consent and scope information \r\n| extend value1 = parse_json(mp) | extend val1 = value1.newValue\r\n| where actinfo == \"ConsentAction.Permissions\"\r\n| parse val1 with * \"ResourceId:\" Resourceid1 \", ConsentType: \" ConsentType \", Scope:\" Scope \"]\" * \r\n| extend Scope1 = split(Scope, \" \")\r\n| mvexpand Scope1 \r\n| where Scope1 != \"\"\r\n| project AppDisplayName = appname\r\n| distinct AppDisplayName)\r\n| distinct AppDisplayName\r\n\r\n\r\n",
                  "crossComponentResources": [
                    "{pn_Workspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "*",
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": [
                    "value::all"
                  ]
                },
                {
                  "id": "56de0861-b28c-4408-9c22-6612b1bad38e",
                  "version": "KqlParameterItem/1.0",
                  "name": "ScopeName1",
                  "label": "Scope Name",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "AuditLogs\r\n| where OperationName contains \"Consent\"\r\n// user name \r\n| extend initby = parse_json(InitiatedBy) | extend userinfo1 = initby.user | extend userinfo2 = parse_json(userinfo1) \r\n| extend username = userinfo2.userPrincipalName\r\n// app name \r\n| extend tr = parse_json(TargetResources) | mvexpand tr | extend appname = tostring(tr.displayName)\r\n| extend mp = tr.modifiedProperties | mvexpand mp\r\n| extend actinfo = mp.displayName\r\n// consent and scope information \r\n| extend value1 = parse_json(mp) | extend val1 = value1.newValue\r\n| where actinfo == \"ConsentAction.Permissions\"\r\n| parse val1 with * \"ResourceId:\" Resourceid1 \", ConsentType: \" ConsentType \", Scope:\" Scope \"]\" * \r\n| extend Scope1 = split(Scope, \" \")\r\n| mvexpand Scope1 \r\n| where Scope1 != \"\"\r\n| project Scope = tostring(Scope1)\r\n| distinct Scope\r\n",
                  "crossComponentResources": [
                    "{pn_Workspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "*",
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": [
                    "value::all"
                  ]
                },
                {
                  "id": "c1dfae76-fa0a-48c4-aa22-2006c098d8a5",
                  "version": "KqlParameterItem/1.0",
                  "name": "API_Name1",
                  "label": "API Name",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "AuditLogs\r\n| where OperationName contains \"Consent\"\r\n// user name \r\n| extend initby = parse_json(InitiatedBy) | extend userinfo1 = initby.user | extend userinfo2 = parse_json(userinfo1) \r\n| extend username = userinfo2.userPrincipalName\r\n// app name \r\n| extend tr = parse_json(TargetResources) | mvexpand tr | extend appname = tostring(tr.displayName)\r\n| extend mp = tr.modifiedProperties | mvexpand mp\r\n| extend actinfo = mp.displayName\r\n// consent and scope information \r\n| extend value1 = parse_json(mp) | extend val1 = value1.newValue\r\n| where actinfo == \"ConsentAction.Permissions\"\r\n| parse val1 with * \"ResourceId:\" Resourceid1 \", ConsentType: \" ConsentType \", Scope:\" Scope \"]\" * \r\n| extend Scope1 = split(Scope, \" \")\r\n| mvexpand Scope1 \r\n| where Scope1 != \"\"\r\n//| project OperationName , username, appname, actinfo, Resourceid1, ConsentType, Scope1, CorrelationId \r\n| join kind = leftouter \r\n(\r\nAuditLogs\r\n| where OperationName contains \"oAuth2\"\r\n| extend tr = parse_json(TargetResources) | mvexpand tr | extend apiname = tostring(tr.displayName)\r\n| where apiname != \"\"\r\n| project OperationName , apiname , CorrelationId\r\n)\r\non $left.CorrelationId == $right.CorrelationId\r\n|distinct apiname\r\n| where apiname !=\"\"\r\n| sort by apiname\r\n",
                  "crossComponentResources": [
                    "{pn_Workspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "*",
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": [
                    "value::all"
                  ]
                },
                {
                  "id": "07ba0b97-f870-4238-a950-e3bf31fe8a6b",
                  "version": "KqlParameterItem/1.0",
                  "name": "Consent_Type1",
                  "label": "Consent Type",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "AuditLogs\r\n| where OperationName contains \"Consent\"\r\n// user name \r\n| extend initby = parse_json(InitiatedBy) | extend userinfo1 = initby.user | extend userinfo2 = parse_json(userinfo1) \r\n| extend username = userinfo2.userPrincipalName\r\n// app name \r\n| extend tr = parse_json(TargetResources) | mvexpand tr | extend appname = tostring(tr.displayName)\r\n| extend mp = tr.modifiedProperties | mvexpand mp\r\n| extend actinfo = mp.displayName\r\n// consent and scope information \r\n| extend value1 = parse_json(mp) | extend val1 = value1.newValue\r\n| where actinfo == \"ConsentAction.Permissions\"\r\n| parse val1 with * \"ResourceId:\" Resourceid1 \", ConsentType: \" ConsentType \", Scope:\" Scope \"]\" * \r\n| project ConsentType \r\n//| where ConsentType != \"\"\r\n|distinct ConsentType\r\n",
                  "crossComponentResources": [
                    "{pn_Workspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "*",
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": [
                    "value::all"
                  ]
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "100",
            "name": "parameters - 4",
            "styleSettings": {
              "margin": "0 0 15px 0"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\r\n| where OperationName contains \"Consent\"\r\n// user name \r\n| extend initby = parse_json(InitiatedBy) | extend userinfo1 = initby.user | extend userinfo2 = parse_json(userinfo1) \r\n| extend username = userinfo2.userPrincipalName\r\n// app name \r\n| extend tr = parse_json(TargetResources) | mvexpand tr | extend appname = tostring(tr.displayName)\r\n| extend mp = tr.modifiedProperties | mvexpand mp\r\n| extend actinfo = mp.displayName\r\n// consent and scope information \r\n| extend value1 = parse_json(mp) | extend val1 = value1.newValue\r\n| where actinfo == \"ConsentAction.Permissions\"\r\n| parse val1 with * \"ResourceId:\" Resourceid1 \", ConsentType: \" ConsentType \", Scope:\" Scope \"]\" * \r\n| extend Scope1 = split(Scope, \" \")\r\n| mvexpand Scope1 \r\n| where Scope1 != \"\"\r\n| project OperationName , username, appname, actinfo, Resourceid1, ConsentType, Scope1, CorrelationId\r\n| where username in ({UserName}) or '*' in  ({UserName})\r\n| where ConsentType in ({Consent_Type1}) or '*' in ({Consent_Type1})\r\n| where appname in ({AppName1}) or '*' in ({AppName1})\r\n| where Scope1 in ({ScopeName1}) or '*' in ({ScopeName1})\r\n| join kind = leftouter \r\n(\r\nAuditLogs\r\n| where OperationName contains \"oAuth2\"\r\n| extend tr = parse_json(TargetResources) | mvexpand tr | extend apiname = tostring(tr.displayName)\r\n| where apiname != \"\"\r\n| project OperationName , apiname , CorrelationId\r\n| where apiname in ({API_Name1}) or '*' in ({API_Name1})\r\n)\r\non $left.CorrelationId == $right.CorrelationId\r\n| join kind = leftouter\r\n(\r\nSigninLogs\r\n| summarize distinctUserSignInCount=dcount(UserId), signInCount=count() by AppDisplayName \r\n) \r\non $left.appname == $right.AppDisplayName\r\n//| extend api_scope = strcat(apiname, \" - \", Scope1) \r\n| extend Scope = tostring(Scope1)\r\n//| distinct Scope, appname, distinctUserSignInCount, signInCount, ConsentType \r\n| summarize Appcount=dcount(appname) by Scope\r\n| sort by Appcount desc\r\n",
              "size": 1,
              "showAnalytics": true,
              "title": "Scope by Unique App Consent Requests",
              "timeContext": {
                "durationMs": 2592000000
              },
              "exportFieldName": "Scope",
              "exportParameterName": "Scope_Bar",
              "exportDefaultValue": "'*'",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Appcount",
                    "formatter": 3,
                    "formatOptions": {
                      "min": 0,
                      "palette": "grayBlue",
                      "showIcon": true
                    }
                  }
                ],
                "rowLimit": 100,
                "labelSettings": [
                  {
                    "columnId": "Scope",
                    "label": "Scope"
                  },
                  {
                    "columnId": "Appcount",
                    "label": "Appcount"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 8"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\r\n| where OperationName contains \"Consent\"\r\n// user name \r\n| extend initby = parse_json(InitiatedBy) | extend userinfo1 = initby.user | extend userinfo2 = parse_json(userinfo1) \r\n| extend username = userinfo2.userPrincipalName\r\n// app name \r\n| extend tr = parse_json(TargetResources) | mvexpand tr | extend appname = tostring(tr.displayName)\r\n| extend mp = tr.modifiedProperties | mvexpand mp\r\n| extend actinfo = mp.displayName\r\n// consent and scope information \r\n| extend value1 = parse_json(mp) | extend val1 = value1.newValue\r\n| where actinfo == \"ConsentAction.Permissions\"\r\n| parse val1 with * \"ResourceId:\" Resourceid1 \", ConsentType: \" ConsentType \", Scope:\" Scope \"]\" * \r\n| extend Scope1 = split(Scope, \" \")\r\n| mvexpand Scope1 \r\n| where Scope1 != \"\"\r\n| project OperationName , username, appname, actinfo, Resourceid1, ConsentType, Scope1, CorrelationId \r\n| where username in ({UserName}) or '*' in  ({UserName})\r\n| where ConsentType in ({Consent_Type1}) or '*' in ({Consent_Type1})\r\n| where appname in ({AppName1}) or '*' in ({AppName1})\r\n| where Scope1 in ({ScopeName1}) or '*' in ({ScopeName1})\r\n| join kind = leftouter \r\n(\r\nAuditLogs\r\n| where OperationName contains \"oAuth2\"\r\n| extend tr = parse_json(TargetResources) | mvexpand tr | extend apiname = tostring(tr.displayName)\r\n| where apiname != \"\"\r\n| project OperationName , apiname , CorrelationId\r\n| where apiname in ({API_Name1}) or '*' in ({API_Name1})\r\n)\r\non $left.CorrelationId == $right.CorrelationId\r\n| join kind = leftouter\r\n(\r\nSigninLogs\r\n| summarize distinctUserSignInCount=dcount(UserId), signInCount=count() by AppDisplayName \r\n) \r\non $left.appname == $right.AppDisplayName\r\n| extend api_scope = tostring(Scope1), API = tostring(apiname) \r\n| distinct  appname, distinctUserSignInCount\r\n",
              "size": 1,
              "showAnalytics": true,
              "title": "Applications by Unique User Sign Ins",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "appname",
              "exportParameterName": "appname",
              "exportDefaultValue": "*",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "distinctUserSignInCount",
                    "formatter": 3,
                    "formatOptions": {
                      "min": 0,
                      "palette": "grayBlue",
                      "showIcon": true
                    }
                  }
                ],
                "rowLimit": 100,
                "labelSettings": [
                  {
                    "columnId": "appname",
                    "label": "appname"
                  },
                  {
                    "columnId": "distinctUserSignInCount",
                    "label": "distinctUserSignInCount"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 0 - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AuditLogs\r\n| where OperationName contains \"Consent\"\r\n// user name \r\n| extend initby = parse_json(InitiatedBy) | extend userinfo1 = initby.user | extend userinfo2 = parse_json(userinfo1) \r\n| extend username = userinfo2.userPrincipalName\r\n// app name \r\n| extend tr = parse_json(TargetResources) | mvexpand tr | extend appname = tostring(tr.displayName)\r\n| extend mp = tr.modifiedProperties | mvexpand mp\r\n| extend actinfo = mp.displayName\r\n// consent and scope information \r\n| extend value1 = parse_json(mp) | extend val1 = value1.newValue\r\n| where actinfo == \"ConsentAction.Permissions\"\r\n| parse val1 with * \"ResourceId:\" Resourceid1 \", ConsentType: \" ConsentType \", Scope:\" Scope \"]\" * \r\n| extend Scope1 = split(Scope, \" \")\r\n| mvexpand Scope1 \r\n| where Scope1 != \"\"\r\n| project OperationName , username, appname, actinfo, Resourceid1, ConsentType, Scope1, CorrelationId \r\n| where username in ({UserName}) or '*' in  ({UserName})\r\n| where ConsentType in ({Consent_Type1}) or '*' in ({Consent_Type1})\r\n| where appname in ({AppName1}) or '*' in ({AppName1})\r\n| where Scope1 in ({ScopeName1}) or '*' in ({ScopeName1})\r\n| join kind = leftouter \r\n(\r\nAuditLogs\r\n| where OperationName contains \"oAuth2\"\r\n| extend tr = parse_json(TargetResources) | mvexpand tr | extend apiname = tostring(tr.displayName)\r\n| where apiname != \"\"\r\n| project OperationName , apiname , CorrelationId\r\n| where apiname in ({API_Name1}) or '*' in ({API_Name1})\r\n)\r\non $left.CorrelationId == $right.CorrelationId\r\n|project UserName = tostring(username),  AppName = appname, ConsentType,  Scope = tostring(Scope1), API = apiname\r\n|distinct UserName, AppName, ConsentType, Scope, API",
              "size": 1,
              "showAnalytics": true,
              "title": "Users by Application, API, Scope, Sign In Counts",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "gridSettings": {
                "rowLimit": 100,
                "labelSettings": [
                  {
                    "columnId": "UserName",
                    "label": "UserName"
                  },
                  {
                    "columnId": "AppName",
                    "label": "AppName"
                  },
                  {
                    "columnId": "ConsentType",
                    "label": "ConsentType"
                  },
                  {
                    "columnId": "Scope",
                    "label": "Scope"
                  },
                  {
                    "columnId": "API",
                    "label": "API"
                  }
                ]
              }
            },
            "name": "query - 3"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "parameters": [
                {
                  "id": "2ecf7153-2928-43d0-8159-ae085e546259",
                  "version": "KqlParameterItem/1.0",
                  "name": "UserDisplayName",
                  "label": "User Display Name",
                  "type": 2,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "let SinginConsentTimes = SigninLogs\r\n| join kind = leftouter\r\n(\r\nSigninLogs\r\n|extend errorCode = Status.errorCode\r\n|where errorCode == 90094 \r\n|distinct CorrelationId \r\n)\r\non $left.CorrelationId == $right.CorrelationId\r\n| summarize maxTime = max(TimeGenerated) by CorrelationId, UserId\r\n| extend corrIDMaxTime = strcat(CorrelationId, maxTime)\r\n| project corrIDMaxTime;\r\nunion\r\nSigninLogs\r\n| extend corrIDTime = strcat(CorrelationId, TimeGenerated)\r\n| where corrIDTime in (SinginConsentTimes)\r\n| extend ConditionalAccessPolicies = tostring(ConditionalAccessPolicies)\r\n| extend DeviceDetail = tostring(DeviceDetail) \r\n| extend LocationDetails = tostring(LocationDetails) \r\n| extend Status = tostring(Status)\r\n| distinct UserDisplayName\r\n| sort by UserDisplayName\r\n\r\n\r\n",
                  "crossComponentResources": [
                    "{pn_Workspace}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "selectAllValue": "*",
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "TimeRange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "value": [
                    "value::all"
                  ]
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let SinginConsentTimes = SigninLogs\r\n| join kind = inner\r\n(\r\nSigninLogs\r\n|extend errorCode = Status.errorCode\r\n|where errorCode == 90094 \r\n|distinct CorrelationId \r\n)\r\non $left.CorrelationId == $right.CorrelationId\r\n| summarize maxTime = max(TimeGenerated) by CorrelationId, UserId\r\n| extend corrIDMaxTime = strcat(CorrelationId, maxTime)\r\n| project corrIDMaxTime;\r\nSigninLogs\r\n| extend corrIDTime = strcat(CorrelationId, TimeGenerated)\r\n| where corrIDTime in (SinginConsentTimes)\r\n| project AppDisplayName, UserId, CorrelationId, ResultType, UserDisplayName\r\n| where AppDisplayName in ({AppName1}) or '*' in ({AppName1})\r\n| where UserDisplayName in ({UserDisplayName}) or '*' in ({UserDisplayName})\r\n//| summarize cnt = count() by ResultType\r\n//| extend SigninStatus = case(ResultType == 0, \"Success\", \"Failure\")\r\n//| summarize cnt = count() by AppDisplayName, SigninStatus\r\n| summarize TotalFlows = count(), TotalUsers = dcount(UserId) by AppDisplayName\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Count of access attempts where user needs admin consent for access",
              "noDataMessage": "There were no access attempts in the time range",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{pn_Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TotalFlows",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "grayBlue",
                      "showIcon": true
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "AppDisplayName",
                    "label": "AppDisplayName"
                  },
                  {
                    "columnId": "TotalFlows",
                    "label": "TotalFlows"
                  }
                ]
              }
            },
            "name": "query - 11"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "ConsentApp"
      },
      "name": "group - 9"
    }
  ],
  "defaultResourceIds": [
    "/subscriptions/da7956a8-3cd9-4b0f-813f-ef8bb305e10b/resourcegroups/rg-we-p-logs-sentinel-001/providers/microsoft.operationalinsights/workspaces/logw-we-p-secutiy-01"
  ],
  "fromTemplateId": "sentinel-UserWorkbook",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}